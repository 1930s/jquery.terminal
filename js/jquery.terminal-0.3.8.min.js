/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                              version 0.3.8
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 LiveQuery plugin Dual MIT and GPL
 Copyright (c) 2008 Brandon Aaron (http://brandonaaron.net)

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

 Date: Sat, 01 Oct 2011 21:22:29 +0000
*/
Array.prototype.has=function(g){for(var v=this.length;v--;)if(this[v]==g)return true;return false};function get_stack(g){return g?[g.toString().match(/.*\n.*\n/)].concat(get_stack(g.caller)):[]}
(function(g,v){function S(b,c){var f;if(typeof b==="string"&&typeof c==="string"){localStorage[b]=c;return true}else if(typeof b==="object"&&typeof c==="undefined"){for(f in b)if(b.hasOwnProperty(f))localStorage[f]=b[f];return true}return false}function P(b,c){var f,e;f=new Date;f.setTime(f.getTime()+31536E6);f="; expires="+f.toGMTString();if(typeof b==="string"&&typeof c==="string"){document.cookie=b+"="+c+f+"; path=/";return true}else if(typeof b==="object"&&typeof c==="undefined"){for(e in b)if(b.hasOwnProperty(e))document.cookie=
e+"="+b[e]+f+"; path=/";return true}return false}function T(b){return localStorage[b]}function U(b){var c,f,e;b+="=";c=document.cookie.split(";");for(f=0;f<c.length;f++){for(e=c[f];e.charAt(0)===" ";)e=e.substring(1,e.length);if(e.indexOf(b)===0)return e.substring(b.length,e.length)}return null}function V(b){return delete localStorage[b]}function W(b){return P(b,"",-1)}function O(b,c){var f=[],e=b.length;if(e<c)return[b];for(var j=0;j<e;j+=c)f.push(b.substring(j,j+c));return f}function x(b){if(typeof b==
"string"){b=b.replace(/&(?!#[0-9]*;)/g,"&amp;");b=b.replace(/</g,"&lt;").replace(/>/g,"&gt;");b=b.replace(/\n/g,"<br/>");b=b.replace(/ /g,"&nbsp;");b=b.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");var c=b.split(X);if(c.length>1)b=g.map(c,function(f){return f[0]=="["?f.replace(Y,function(e,j,q,t,B){e="";if(j.indexOf("b")!=-1)e+="font-weight:bold;";if(j.indexOf("u")!=-1)e+="text-decoration:underline;";if(j.indexOf("i")!=-1)e+="font-style:italic; ";if(q.match(Q))e+="color:"+q+";";if(t.match(Q))e+="background-color:"+
t;return b='<span style="'+e+'">'+B+"</span>"}):"<span>"+f+"</span>"}).join("");return b}else return""}function R(b){var c=b instanceof Array?b:b?[b]:[],f=0;g.extend(this,{left:function(){if(f===0)f=c.length-1;else--f;return c[f]},right:function(){if(f==c.length-1)f=0;else++f;return c[f]},current:function(){return c[f]},data:function(){return c},length:function(){return c.length},reset:function(){f=0},append:function(e){c.push(e);this.reset()}})}function Z(b){var c=b?[b]:[];g.extend(this,{size:function(){return c.length},
pop:function(){if(c.length===0)return null;else{var f=c[c.length-1];c=c.slice(0,c.length-1);return f}},push:function(f){c=c.concat([f]);return f},top:function(){return c.length>0?c[c.length-1]:null}})}function $(b){var c=true;if(typeof b==="string"&&b!=="")b+="_";var f=g.Storage.get(b+"commands"),e=new R(f?eval("("+f+")"):[""]);g.extend(this,{append:function(j){if(c&&e.current()!=j){e.append(j);g.Storage.set(b+"commands",g.json_stringify(e.data()))}},data:function(){return e.data()},next:function(){return e.right()},
last:function(){e.reset()},previous:function(){return e.left()},clear:function(){e=new R;g.Storage.remove(b+"commands")},enable:function(){c=true},disable:function(){c=false}})}g.extend(g.fn,{livequery:function(b,c,f){var e=this,j;if(g.isFunction(b)){f=c;c=b;b=v}g.each(g.livequery.queries,function(q,t){if(e.selector==t.selector&&e.context==t.context&&b==t.type&&(!c||c.$lqguid==t.fn.$lqguid)&&(!f||f.$lqguid==t.fn2.$lqguid))return(j=t)&&false});j=j||new g.livequery(this.selector,this.context,b,c,f);
j.stopped=false;j.run();return this},expire:function(b,c,f){var e=this;if(g.isFunction(b)){f=c;c=b;b=v}g.each(g.livequery.queries,function(j,q){if(e.selector==q.selector&&e.context==q.context&&(!b||b==q.type)&&(!c||c.$lqguid==q.fn.$lqguid)&&(!f||f.$lqguid==q.fn2.$lqguid)&&!this.stopped)g.livequery.stop(q.id)});return this}});g.livequery=function(b,c,f,e,j){this.selector=b;this.context=c||document;this.type=f;this.fn=e;this.fn2=j;this.elements=[];this.stopped=false;this.id=g.livequery.queries.push(this)-
1;e.$lqguid=e.$lqguid||g.livequery.guid++;if(j)j.$lqguid=j.$lqguid||g.livequery.guid++;return this};g.livequery.prototype={stop:function(){var b=this;if(this.type)this.elements.unbind(this.type,this.fn);else this.fn2&&this.elements.each(function(c,f){b.fn2.apply(f)});this.elements=[];this.stopped=true},run:function(){if(!this.stopped){var b=this,c=this.elements,f=g(this.selector,this.context),e=f.not(c);this.elements=f;if(this.type){e.bind(this.type,this.fn);c.length>0&&g.each(c,function(j,q){g.inArray(q,
f)<0&&g.event.remove(q,b.type,b.fn)})}else{e.each(function(){b.fn.apply(this)});this.fn2&&c.length>0&&g.each(c,function(j,q){g.inArray(q,f)<0&&b.fn2.apply(q)})}}}};g.extend(g.livequery,{guid:0,queries:[],queue:[],running:false,timeout:null,checkQueue:function(){if(g.livequery.running&&g.livequery.queue.length)for(var b=g.livequery.queue.length;b--;)g.livequery.queries[g.livequery.queue.shift()].run()},pause:function(){g.livequery.running=false},play:function(){g.livequery.running=true;g.livequery.run()},
registerPlugin:function(){g.each(arguments,function(b,c){if(g.fn[c]){var f=g.fn[c];g.fn[c]=function(){var e=f.apply(this,arguments);g.livequery.run();return e}}})},run:function(b){if(b!=v)g.inArray(b,g.livequery.queue)<0&&g.livequery.queue.push(b);else g.each(g.livequery.queries,function(c){g.inArray(c,g.livequery.queue)<0&&g.livequery.queue.push(c)});g.livequery.timeout&&clearTimeout(g.livequery.timeout);g.livequery.timeout=setTimeout(g.livequery.checkQueue,20)},stop:function(b){b!=v?g.livequery.queries[b].stop():
g.each(g.livequery.queries,function(c){g.livequery.queries[c].stop()})}});g.livequery.registerPlugin("append","prepend","after","before","wrap","attr","removeAttr","addClass","removeClass","toggleClass","empty","remove");g(function(){g.livequery.play()});var aa=g.prototype.init;g.prototype.init=function(b,c){var f=aa.apply(this,arguments);if(b&&b.selector){f.context=b.context;f.selector=b.selector}if(typeof b=="string"){f.context=c||document;f.selector=b}return f};g.prototype.init.prototype=g.prototype;
var L=typeof window.localStorage!=="undefined";g.extend({Storage:{set:L?S:P,get:L?T:U,remove:L?V:W}});jQuery.fn.extend({everyTime:function(b,c,f,e,j){return this.each(function(){jQuery.timer.add(this,b,c,f,e,j)})},oneTime:function(b,c,f){return this.each(function(){jQuery.timer.add(this,b,c,f,1)})},stopTime:function(b,c){return this.each(function(){jQuery.timer.remove(this,b,c)})}});jQuery.extend({timer:{guid:1,global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},
timeParse:function(b){if(b==v||b==null)return null;var c=this.regex.exec(jQuery.trim(b.toString()));return c[2]?parseInt(c[1],10)*(this.powers[c[2]]||1):b},add:function(b,c,f,e,j,q){var t=0;if(jQuery.isFunction(f)){j||(j=e);e=f;f=c}c=jQuery.timer.timeParse(c);if(!(typeof c!="number"||isNaN(c)||c<=0)){if(j&&j.constructor!=Number){q=!!j;j=0}j=j||0;q=q||false;if(!b.$timers)b.$timers={};b.$timers[f]||(b.$timers[f]={});e.$timerID=e.$timerID||this.guid++;var B=function(){if(!(q&&this.inProgress)){this.inProgress=
true;if(++t>j&&j!==0||e.call(b,t)===false)jQuery.timer.remove(b,f,e);this.inProgress=false}};B.$timerID=e.$timerID;b.$timers[f][e.$timerID]||(b.$timers[f][e.$timerID]=window.setInterval(B,c));this.global[f]||(this.global[f]=[]);this.global[f].push(b)}},remove:function(b,c,f){var e=b.$timers,j;if(e){if(c){if(e[c]){if(f){if(f.$timerID){window.clearInterval(e[c][f.$timerID]);delete e[c][f.$timerID]}}else for(f in e[c]){window.clearInterval(e[c][f]);delete e[c][f]}for(j in e[c])break;if(!j){j=null;delete e[c]}}}else for(c in e)this.remove(b,
c,f);for(j in e)break;if(!j)b.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",function(){var b=jQuery.timer.global,c;for(c in b)for(var f=b[c],e=f.length;--e;)jQuery.timer.remove(f[e],c)});var X=/(\[\[[biu]*;[^;]*;[^\]]*\][^\]]*\])/g,Y=/\[\[([biu]*);([^;]*);([^\]]*)\]([^\]]*)\]/g,Q=/#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})/;g.json_stringify=function(b,c){var f="";c=c===v?1:c;switch(typeof b){case "function":f+=b;break;case "boolean":f+=b?"true":"false";break;case "object":if(b===null)f+=
"null";else if(b instanceof Array){f+="[";for(var e=b.length,j=0;j<e-1;++j)f+=g.json_stringify(b[j],c+1);f+=g.json_stringify(b[e-1],c+1)+"]"}else{f+="{";for(e in b)if(b.hasOwnProperty(e))f+='"'+e+'":'+g.json_stringify(b[e],c+1);f+="}"}break;case "string":e=b;var q={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};for(j in q)if(q.hasOwnProperty(j))e=e.replace(RegExp(j,"g"),q[j]);f+='"'+e+'"';break;case "number":f+=String(b)}f+=c>1?",":"";if(c==1)f=f.replace(/,([\]}])/g,"$1");
return f.replace(/([\[{]),/g,"$1")};g.fn.cmd=function(b){function c(){F.toggleClass("inverted")}function f(){j.focus();e.oneTime(1,function(){e.insert(j.val());j.blur();j.val("")})}var e=this;e.addClass("cmd");e.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');var j=g("<textarea/>").addClass("clipboard").appendTo(e);b.width&&e.width(b.width);var q,t,B=b.mask||false,m="",n=0,C,D=b.enabled,M,z,F=e.find(".cursor"),d=function(h){function r(k,a){if(a==
k.length){y.html(x(k));F.html("&nbsp;");w.html("")}else if(a===0){y.html("");F.html(x(k.slice(0,1)));w.html(x(k.slice(1)))}else{var i=x(k.slice(0,a));y.html(i);i=k.slice(a,a+1);F.html(i==" "?"&nbsp;":x(i));a==k.lenght-1?w.html(""):w.html(x(k.slice(a+1)))}}function A(k){return"<div>"+x(k)+"</div>"}function l(k){var a=w;g.each(k,function(i,o){a=g(A(o)).insertAfter(a).addClass("clear")})}function J(k){g.each(k,function(a,i){y.before(A(i))})}var y=F.prev(),w=F.next();return function(){var k=B?m.replace(/./g,
"*"):m;h.find("div").remove();y.html("");if(k.length>q-t-1||k.match(/\n/)){var a;if(k.match(/\n/)){for(var i=k.split("\n"),o=q-t-1,p=0;p<i.length-1;++p)i[p]+=" ";if(i[0].length>o){a=[i[0].substring(0,o)];a=a.concat(O(i[0].substring(o),q))}else a=[i[0]];for(p=1;p<i.length;++p)if(i[p].length>q)a=a.concat(O(i[p],q));else a.push(i[p])}else{a=k.substring(0,q-t-1);o=k.substring(q-t-1);a=[a].concat(O(o,q))}o=a[0].length;if(n<o){r(a[0],n);l(a.slice(1))}else if(n==o){y.before(A(a[0]));r(a[1],0);l(a.slice(2))}else{p=
a.length;if(n<o){r(a[0],n);l(a.slice(1))}else if(n==o){y.before(A(a[0]));r(a[1],0);l(a.slice(2))}else{i=a.slice(-1)[0];var s=k.length-n;k=0;if(s<=i.length){J(a.slice(0,-1));k=i.length==s?0:i.length-s;r(i,k)}else if(p==3){y.before("<div>"+x(a[0])+"</div>");r(a[1],n-o-1);w.after('<div class="clear">'+x(a[2])+"</div>")}else{console&&console.dir(a);k=n;for(p=0;p<a.length;++p)if(k>a[p].length)k-=a[p].length;else break;o=a[p];if(k==o.length){k=0;o=a[++p]}r(o,k);J(a.slice(0,p));l(a.slice(p+1))}}}}else if(k===
""){y.html("");F.html("&nbsp;");w.html("")}else r(k,n)}}(e),G=function(){var h=e.find(".prompt");return function(){if(typeof C=="string"){t=C.length;h.html(x(C)+"&nbsp;")}else C(function(r){t=r.length;h.html(x(r)+"&nbsp;")})}}();g.extend(e,{name:function(h){if(h!==v){M=h;z=new $(h)}else return M},history:function(){return z},set:function(h,r){if(h!==v){m=h;if(!r)n=m.length;d()}},insert:function(h,r){if(n==m.length)m+=h;else m=n===0?h+m:m.slice(0,n)+h+m.slice(n);r||(n+=h.length);d()},get:function(){return m},
commands:function(h){if(h)b.commands=h;else return h},destroy:function(){g(document.documentElement).unbind(".commandline");e.find(".prompt").remove()},prompt:function(h){if(h===v)return C;else{if(typeof h=="string"||typeof h=="function")C=h;else throw"prompt must be a function or string";G()}},position:function(h){if(typeof h=="number"){n=h<0?0:h>m.length?m.length:h;d()}else return n},resize:function(h){if(h)q=h;else{h=e.width();var r=F.innerWidth();q=Math.floor(h/r)}d()},enable:function(){if(!D){e.everyTime(500,
"blink",c);D=true}},isenabled:function(){return D},disable:function(){if(D){e.stopTime("blink",c);e.find(".cursor").removeClass("inverted");D=false}},mask:function(h){if(typeof h=="boolean"){B=h;d()}else return B}});e.name(b.name||"");C=b.prompt||">";G();if(b.enabled===v||b.enabled===true)e.enable();g(document.documentElement).keypress(function(h){var r;if(h.ctrlKey&&h.which==99)return true;if(b.keypress)r=b.keypress(h);if(r===v||r){if(D)if([38,32,13,0,8].has(h.which)&&h.keyCode!=123&&!(h.which==
38&&h.shiftKey))return false;else if(!h.ctrlKey&&!(h.altKey&&h.which==100)){e.insert(String.fromCharCode(h.which));return false}}else return r;if(h.which==100&&h.ctrlKey)return false}).keydown(function(h){if(b.keydown&&b.keydown(h)===false)return false;if(D){var r;if(h.keyCode==13){z&&m&&z.append(m);z.last();h=m;e.set("");typeof C=="function"&&G();b.commands&&b.commands(h)}else if(h.which==32)e.insert(" ");else if(h.which==8){if(m!==""&&n>0){m=m.slice(0,n-1)+m.slice(n,m.length);--n;d()}}else if(h.which==
9&&!(h.ctrlKey||h.altKey))e.insert("\t");else if(h.which==46||h.which==68&&h.ctrlKey){if(m!==""&&n<m.length){m=m.slice(0,n)+m.slice(n+1,m.length);d()}return true}else if(z&&h.which==38||h.which==80&&h.ctrlKey)e.set(z.previous());else if(z&&h.which==40||h.which==78&&h.ctrlKey)e.set(z.next());else if(h.which==37||h.which==66&&h.ctrlKey)if(h.ctrlKey&&h.which!=66){r=n-1;h=0;for(m[r]==" "&&--r;r>0;--r)if(m[r]==" "&&m[r+1]!=" "){h=r+1;break}else if(m[r]=="\n"&&m[r+1]!="\n"){h=r;break}e.position(h)}else{if(n>
0){--n;d()}}else if(h.which==39||h.which==70&&h.ctrlKey)if(h.ctrlKey&&h.which!=70){m[n]==" "&&++n;h=m.slice(n).match(/\S[\n\s]{2,}|[\n\s]+\S?/);if(!h||h[0].match(/^\s+$/))n=m.length;else if(h[0][0]!=" ")n+=h.index+1;else{n+=h.index+h[0].length-1;h[0][h[0].length-1]!=" "&&--n}d()}else{if(n<m.length){++n;d()}}else if(h.which==123)return true;else if(h.which==36)e.position(0);else if(h.which==35)e.position(m.length);else if(h.ctrlKey||h.metaKey)if(h.shiftKey){if(h.which==84)return true}else{if(!h.altKey)if(h.which==
65)e.position(0);else if(h.which==69)e.position(m.length);else if(h.which==88||h.which==67||h.which==87||h.which==84)return true;else if(h.which==86){f();return true}else if(h.which==75)if(n===0)e.set("");else n!=m.length&&e.set(m.slice(0,n));else if(h.which==85)e.set("");else if(h.which==17)return true}else if(h.altKey)h.which==68&&e.set(m.slice(0,n)+m.slice(n).replace(/[^ ]+ |[^ ]+$/,""),true);else return true;return false}});return e};var N=[];g.jrpc=function(b,c,f,e,j,q){c=g.json_stringify({jsonrpc:"2.0",
method:f,params:e,id:c});return g.ajax({url:b,data:c,success:j,error:q,contentType:"application/json",dataType:"json",beforeSend:function(t){N.push(t)},async:true,cache:false,type:"POST"})};L=/ {13}$/;var ba=[["jQuery Terminal","(c) 2011 jcubic"],["JQuery Terminal Emulator v. 0.3.8","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,"")],["JQuery Terminal Emulator version version 0.3.8","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      _______                 ________                        __",
"     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /","/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\__/____/_/ \\__ / /_/____/_//_/ /_/ /_/  \\/\\__\\_\\___/","         \\/          /____/                                   ".replace(L,"")+"version 0.3.8","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      __ _____                     ________                              __",
"     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /","/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                          ".replace(L,"")+"version 0.3.8","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],H=new function(b){var c=
b?[b]:[],f=0;g.extend(this,{rotate:function(){if(c.length==1)return c[0];else{if(f==c.length-1)f=0;else++f;return c[f]}},length:function(){return c.length},set:function(e){for(var j=c.length;j--;)if(c[j]===e){f=j;return}this.append(e)},front:function(){return c[f]},append:function(e){c.push(e)}})};N=[];g.fn.terminal=function(b,c){function f(){var a=g("<span>x</span>").appendTo(d),i=Math.floor(d.width()/a.width());a.remove();return i}function e(a,i){if(typeof a=="string")d.error("&#91;"+i+"&#93;: "+
a);else{d.error("&#91;"+i+"&#93;: "+a.fileName+": "+a.message);d.pause();g.get(a.fileName,function(o){d.resume();var p=a.lineNumber-1;d.error("&#91;"+a.lineNumber+"&#93;: "+o.split("\n")[p])})}}function j(a,i){try{if(typeof i=="function")i(function(){});else if(typeof i!="string")throw a+" must be string or function";}catch(o){e(o,a.toUpperCase());return false}return true}function q(){var a=d.prop?d.prop("scrollHeight"):d.attr("scrollHeight");d.scrollTop(a)}function t(a){a=typeof a=="string"?a:String(a);
var i;if(a.length>A){a=a.split("\n");i=g("<div></div>");for(var o=a.length,p=0;p<o;++p)if(a[p]===""||a[p]=="\r")i.append("<div>&nbsp;</div>");else if(a[p].length>A){var s=O(a[p],A);g.each(s,function(E,u){g("<div/>").html(x(u)).appendTo(i)})}else g("<div/>").html(x(a[p])).appendTo(i)}else i=g("<div/>").html(x(a));h.append(i);i.width("100%");q();return i}function B(a,i){var o=1,p=function(s,E){i.pause();g.jrpc(a,o++,s,E,function(u){if(u.error)i.error("&#91;RPC&#93; "+u.error.message);else if(typeof u.result==
"string")i.echo(u.result);else if(u.result instanceof Array)i.echo(u.result.join(" "));else if(typeof u.result=="object"){var I="",K;for(K in u.result)if(u.result.hasOwnProperty(K))I+=K+": "+u.result[K]+"\n";i.echo(I)}i.resume()},function(u,I){i.error("&#91;AJAX&#93; "+I+" - Server reponse is: \n"+u.responseText);i.resume()})};return function(s,E){if(s!==""){var u,I;if(s.match(/[^ ]* /)){s=s.split(/ +/);u=s[0];I=s.slice(1)}else{u=s;I=[]}if(!l.login||u=="help")p(u,I);else{var K=E.token();K?p(u,[K].concat(I)):
E.error("&#91;AUTH&#93; Access denied (no token)")}}}}function m(a){var i=k.prompt();if(k.mask())a=a.replace(/./g,"*");typeof i=="function"?i(function(o){d.echo(o+" "+a)}):d.echo(i+" "+a)}function n(a){try{var i=w.top();if(a=="exit"&&l.exit)if(w.size()==1)l.login?D():d.echo("You can exit from main interpeter");else d.pop("exit");else{m(a);a=="clear"&&l.clear?d.clear():i.eval(a,d)}}catch(o){e(o,"USER");throw o;}}function C(){var a=null;k.prompt("login:");l.history&&k.history().disable();k.commands(function(i){try{m(i);
if(a){k.mask(false);d.pause();l.login(a,i,function(p){if(p){var s=l.name;s=s?"_"+s:"";g.Storage.set("token"+s,p);g.Storage.set("login"+s,a);k.commands(n);z()}else{d.error("Wrong password try again");k.prompt("login:");a=null}d.resume();l.history&&k.history().enable()})}else{a=i;k.prompt("password:");k.mask(true)}}catch(o){e(o,"LOGIN",d);throw o;}})}function D(){var a=l.name;a=a?"_"+a:"";g.Storage.remove("token"+a,null);g.Storage.remove("login"+a,null);l.history&&k.history().disable();C()}function M(){var a=
w.top(),i="";if(a.name!==v&&a.name!=="")i+=a.name+"_";i+=r;k.name(i);k.prompt(a.prompt);l.history&&k.history().enable();k.set("");if(typeof a.onStart=="function")a.onStart(d)}function z(){M();if(c.greetings===v)d.echo(d.signature);else c.greetings&&d.echo(c.greetings);if(typeof l.onInit=="function")l.onInit(d)}function F(a){if(l.keydown&&l.keydown(a,d)===false)return false;if(d.paused()){if(a.which==68&&a.ctrlKey){for(a=N.length;a--;){var i=N[a];if(4!=i.readyState)try{i.abort()}catch(o){d.error("error in aborting ajax")}}d.resume();
return false}}else if(a.which==68&&a.ctrlKey){if(l.exit)if(k.get()==="")if(w.size()>1||l.login!==v)d.pop("");else{d.resume();d.echo("")}else d.set_command("");return false}else if(a.which==86&&a.ctrlKey){d.oneTime(1,function(){q()});return true}else if(a.which==9&&a.ctrlKey){H.length()>1&&d.focus(false);a.preventDefault()}else if(a.which==34)d.scroll(d.height());else a.which==33?d.scroll(-d.height()):d.attr({scrollTop:d.attr("scrollHeight")})}var d=this,G=[],h,r=H.length(),A,l={name:null,prompt:">",
history:true,exit:true,clear:true,enabled:true,login:null,onInit:null,onExit:null,keypress:null,keydown:null};if(c){c.width&&d.width(c.width);c.height&&d.height(c.height);g.extend(l,c)}var J=!l.enabled;if(d.length===0)throw'Sorry, but terminal said that "'+d.selector+'" is not valid selector';d.ajaxSend(function(a,i){N.push(i)});if(d.data("terminal"))return d.data("terminal");h=g("<div>").addClass("terminal-output").appendTo(d);d.addClass("terminal").append("<div/>");g.extend(d,{clear:function(){h.html("");
k.set("");G=[];d.attr({scrollTop:0});return d},paused:function(){return J},pause:function(){if(k){d.disable();k.hide()}return d},resume:function(){if(k){d.enable();k.show();q()}return d},cols:function(){return A},rows:function(){return G.length},history:function(){return k.history().data()},next:function(){if(H.length()==1)return d;else{var a=d.offset().top;d.height();d.scrollTop();var i=d,o=g(window).scrollTop(),p=o+g(window).height(),s=g(i).offset().top;if(s+g(i).height()>=o&&s<=p){H.front().disable();
a=H.rotate().enable();i=a.offset().top-50;g("html,body").animate({scrollTop:i},500);return a}else{d.enable();g("html,body").animate({scrollTop:a-50},500);return d}}},focus:function(a){d.oneTime(1,function(){if(H.length()==1)a===false?d.disable():d.enable();else if(a===false)d.next();else{H.front().disable();H.set(d);d.enable()}});return d},enable:function(){A===v&&d.resize();if(J)if(k){k.enable();J=false}return d},disable:function(){if(k){J=true;k.disable()}return d},enabled:function(){return J},
signature:function(){var a=d.cols();a=a<15?null:a<35?0:a<55?1:a<64?2:a<75?3:4;return a!==null?ba[a].join("\n")+"\n":""},version:function(){return"0.3.8"},get_command:function(){return k.get()},insert:function(a){k.insert(a);return d},set_prompt:function(a){j("prompt",a)&&k.prompt(a);return d},set_command:function(a){k.set(a);return d},set_mask:function(a){k.mask(a);return d},get_output:function(){return g.map(G,function(a,i){return typeof i=="function"?i():i}).get().join("\n")},resize:function(a,
i){if(a&&i){d.width(a);d.height(i)}A=f();k.resize(A);var o=h.detach();h.html("");g.each(G,function(p,s){t(typeof s=="function"?s():s)});d.prepend(o);q();return d},echo:function(a){G.push(a);return t(typeof a=="function"?a():a)},error:function(a){d.echo(a).addClass("error")},scroll:function(a){if(d.prop){a>d.prop("scrollTop")&&a>0&&d.prop("scrollTop",0);var i=d.prop("scrollTop");d.prop("scrollTop",i+a)}else{a>d.attr("scrollTop")&&a>0&&d.attr("scrollTop",0);i=d.attr("scrollTop");d.attr("scrollTop",
i+a)}return d},logout:l.login?function(){for(;w.size()>1;)w.pop();D();return d}:function(){throw"You don't have login function";},token:l.login?function(){var a=l.name;return g.Storage.get("token"+(a?"_"+a:""))}:null,login_name:l.login?function(){var a=l.name;return g.Storage.get("login"+(a?"_"+a:""))}:null,name:function(){return l.name},push:function(a,i){if(!i.prompt||j("prompt",i.prompt)){if(typeof a=="string")a=B(i.eval,d);w.push(g.extend({eval:a},i));M()}return d},pop:function(a){a!==v&&m(a);
if(w.top().name===l.name){if(l.login){D();if(typeof l.onExit=="function")l.onExit(d)}}else{a=w.pop();M();if(typeof a.onExit=="function")a.onExit(d)}return d}});var y;switch(typeof b){case "string":y=b;b=B(b,d);break;case "object":b=function(a){return function(i){if(i!=""){i=i.split(/ */);var o=i[0];i=i.slice(1);var p=a[o];typeof p=="function"?p.apply(d,i):d.echo("Command '"+o+"' Not Found")}}}(b)}if(y&&typeof l.login=="string"||y)l.login=function(a){var i=1;return function(o,p,s){d.pause();g.jrpc(y,
i++,a,[o,p],function(E){d.resume();!E.error&&E.result?s(E.result):s(null)},function(E,u){d.resume();d.error("&#91;AJAX&#92; Response: "+u+"\n"+E.responseText)})}}(typeof l.login=="boolean"?"login":l.login);if(j("prompt",l.prompt)){var w=new Z({name:l.name,eval:b,prompt:l.prompt,greetings:l.greetings}),k=d.find(".terminal-output").next().cmd({prompt:l.prompt,history:l.history,width:"100%",keydown:F,keypress:l.keypress?function(a){return l.keypress(a,d)}:null,commands:n});d.livequery(function(){d.resize()});
H.append(d);l.enabled===true?d.focus():d.disable();g(window).resize(d.resize);d.click(function(){d.focus()});d.token&&!d.token()&&d.login_name&&!d.login_name()?C():z();typeof g.fn.init.prototype.mousewheel==="function"&&d.mousewheel(function(a,i){i>0?d.scroll(-40):d.scroll(40);return false},true)}d.data("terminal",d);return d}})(jQuery);
