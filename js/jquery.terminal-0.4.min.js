/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                              version 0.4
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 LiveQuery plugin Dual MIT and GPL
 Copyright (c) 2008 Brandon Aaron (http://brandonaaron.net)

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

 Date: Thu, 06 Oct 2011 19:52:56 +0000
*/
Array.prototype.has=function(g){for(var y=this.length;y--;)if(this[y]==g)return true;return false};function get_stack(g){return g?[g.toString().match(/.*\n.*\n/)].concat(get_stack(g.caller)):[]}
(function(g,y){function V(a,c){var f;if(typeof a==="string"&&typeof c==="string"){localStorage[a]=c;return true}else if(typeof a==="object"&&typeof c==="undefined"){for(f in a)if(a.hasOwnProperty(f))localStorage[f]=a[f];return true}return false}function R(a,c){var f,e;f=new Date;f.setTime(f.getTime()+31536E6);f="; expires="+f.toGMTString();if(typeof a==="string"&&typeof c==="string"){document.cookie=a+"="+c+f+"; path=/";return true}else if(typeof a==="object"&&typeof c==="undefined"){for(e in a)if(a.hasOwnProperty(e))document.cookie=
e+"="+a[e]+f+"; path=/";return true}return false}function W(a){return localStorage[a]}function X(a){var c,f,e;a+="=";c=document.cookie.split(";");for(f=0;f<c.length;f++){for(e=c[f];e.charAt(0)===" ";)e=e.substring(1,e.length);if(e.indexOf(a)===0)return e.substring(a.length,e.length)}return null}function Y(a){return delete localStorage[a]}function Z(a){return R(a,"",-1)}function Q(a,c){var f=[],e=a.length;if(e<c)return[a];for(var j=0;j<e;j+=c)f.push(a.substring(j,j+c));return f}function B(a){if(typeof a==
"string"){a=a.replace(/&(?!#[0-9]*;)/g,"&amp;");a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;");a=a.replace(/\n/g,"<br/>");a=a.replace(/ /g,"&nbsp;");a=a.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");var c=a.split(S);if(c.length>1)a=g.map(c,function(f){return f[0]=="["?f.replace($,function(e,j,r,x,G){e="";if(j.indexOf("b")!=-1)e+="font-weight:bold;";if(j.indexOf("u")!=-1)e+="text-decoration:underline;";if(j.indexOf("i")!=-1)e+="font-style:italic; ";if(r.match(T))e+="color:"+r+";";if(x.match(T))e+="background-color:"+
x;return a='<span style="'+e+'">'+G+"</span>"}):"<span>"+f+"</span>"}).join("");return a}else return""}function U(a){var c=a instanceof Array?a:a?[a]:[],f=0;g.extend(this,{left:function(){if(f===0)f=c.length-1;else--f;return c[f]},right:function(){if(f==c.length-1)f=0;else++f;return c[f]},current:function(){return c[f]},data:function(){return c},length:function(){return c.length},reset:function(){f=0},append:function(e){c.push(e);this.reset()}})}function aa(a){var c=a?[a]:[];g.extend(this,{size:function(){return c.length},
pop:function(){if(c.length===0)return null;else{var f=c[c.length-1];c=c.slice(0,c.length-1);return f}},push:function(f){c=c.concat([f]);return f},top:function(){return c.length>0?c[c.length-1]:null}})}function ba(a){var c=true;if(typeof a==="string"&&a!=="")a+="_";var f=g.Storage.get(a+"commands"),e=new U(f?eval("("+f+")"):[""]);g.extend(this,{append:function(j){if(c&&e.current()!=j){e.append(j);g.Storage.set(a+"commands",g.json_stringify(e.data()))}},data:function(){return e.data()},next:function(){return e.right()},
last:function(){e.reset()},previous:function(){return e.left()},clear:function(){e=new U;g.Storage.remove(a+"commands")},enable:function(){c=true},disable:function(){c=false}})}g.extend(g.fn,{livequery:function(a,c,f){var e=this,j;if(g.isFunction(a)){f=c;c=a;a=y}g.each(g.livequery.queries,function(r,x){if(e.selector==x.selector&&e.context==x.context&&a==x.type&&(!c||c.$lqguid==x.fn.$lqguid)&&(!f||f.$lqguid==x.fn2.$lqguid))return(j=x)&&false});j=j||new g.livequery(this.selector,this.context,a,c,f);
j.stopped=false;j.run();return this},expire:function(a,c,f){var e=this;if(g.isFunction(a)){f=c;c=a;a=y}g.each(g.livequery.queries,function(j,r){if(e.selector==r.selector&&e.context==r.context&&(!a||a==r.type)&&(!c||c.$lqguid==r.fn.$lqguid)&&(!f||f.$lqguid==r.fn2.$lqguid)&&!this.stopped)g.livequery.stop(r.id)});return this}});g.livequery=function(a,c,f,e,j){this.selector=a;this.context=c||document;this.type=f;this.fn=e;this.fn2=j;this.elements=[];this.stopped=false;this.id=g.livequery.queries.push(this)-
1;e.$lqguid=e.$lqguid||g.livequery.guid++;if(j)j.$lqguid=j.$lqguid||g.livequery.guid++;return this};g.livequery.prototype={stop:function(){var a=this;if(this.type)this.elements.unbind(this.type,this.fn);else this.fn2&&this.elements.each(function(c,f){a.fn2.apply(f)});this.elements=[];this.stopped=true},run:function(){if(!this.stopped){var a=this,c=this.elements,f=g(this.selector,this.context),e=f.not(c);this.elements=f;if(this.type){e.bind(this.type,this.fn);c.length>0&&g.each(c,function(j,r){g.inArray(r,
f)<0&&g.event.remove(r,a.type,a.fn)})}else{e.each(function(){a.fn.apply(this)});this.fn2&&c.length>0&&g.each(c,function(j,r){g.inArray(r,f)<0&&a.fn2.apply(r)})}}}};g.extend(g.livequery,{guid:0,queries:[],queue:[],running:false,timeout:null,checkQueue:function(){if(g.livequery.running&&g.livequery.queue.length)for(var a=g.livequery.queue.length;a--;)g.livequery.queries[g.livequery.queue.shift()].run()},pause:function(){g.livequery.running=false},play:function(){g.livequery.running=true;g.livequery.run()},
registerPlugin:function(){g.each(arguments,function(a,c){if(g.fn[c]){var f=g.fn[c];g.fn[c]=function(){var e=f.apply(this,arguments);g.livequery.run();return e}}})},run:function(a){if(a!=y)g.inArray(a,g.livequery.queue)<0&&g.livequery.queue.push(a);else g.each(g.livequery.queries,function(c){g.inArray(c,g.livequery.queue)<0&&g.livequery.queue.push(c)});g.livequery.timeout&&clearTimeout(g.livequery.timeout);g.livequery.timeout=setTimeout(g.livequery.checkQueue,20)},stop:function(a){a!=y?g.livequery.queries[a].stop():
g.each(g.livequery.queries,function(c){g.livequery.queries[c].stop()})}});g.livequery.registerPlugin("append","prepend","after","before","wrap","attr","removeAttr","addClass","removeClass","toggleClass","empty","remove");g(function(){g.livequery.play()});var ca=g.prototype.init;g.prototype.init=function(a,c){var f=ca.apply(this,arguments);if(a&&a.selector){f.context=a.context;f.selector=a.selector}if(typeof a=="string"){f.context=c||document;f.selector=a}return f};g.prototype.init.prototype=g.prototype;
var O=typeof window.localStorage!=="undefined";g.extend({Storage:{set:O?V:R,get:O?W:X,remove:O?Y:Z}});jQuery.fn.extend({everyTime:function(a,c,f,e,j){return this.each(function(){jQuery.timer.add(this,a,c,f,e,j)})},oneTime:function(a,c,f){return this.each(function(){jQuery.timer.add(this,a,c,f,1)})},stopTime:function(a,c){return this.each(function(){jQuery.timer.remove(this,a,c)})}});jQuery.extend({timer:{guid:1,global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},
timeParse:function(a){if(a==y||a===null)return null;var c=this.regex.exec(jQuery.trim(a.toString()));return c[2]?parseInt(c[1],10)*(this.powers[c[2]]||1):a},add:function(a,c,f,e,j,r){var x=0;if(jQuery.isFunction(f)){j||(j=e);e=f;f=c}c=jQuery.timer.timeParse(c);if(!(typeof c!="number"||isNaN(c)||c<=0)){if(j&&j.constructor!=Number){r=!!j;j=0}j=j||0;r=r||false;if(!a.$timers)a.$timers={};a.$timers[f]||(a.$timers[f]={});e.$timerID=e.$timerID||this.guid++;var G=function(){if(!(r&&this.inProgress)){this.inProgress=
true;if(++x>j&&j!==0||e.call(a,x)===false)jQuery.timer.remove(a,f,e);this.inProgress=false}};G.$timerID=e.$timerID;a.$timers[f][e.$timerID]||(a.$timers[f][e.$timerID]=window.setInterval(G,c));this.global[f]||(this.global[f]=[]);this.global[f].push(a)}},remove:function(a,c,f){var e=a.$timers,j;if(e){if(c){if(e[c]){if(f){if(f.$timerID){window.clearInterval(e[c][f.$timerID]);delete e[c][f.$timerID]}}else for(f in e[c]){window.clearInterval(e[c][f]);delete e[c][f]}for(j in e[c])break;if(!j){j=null;delete e[c]}}}else for(c in e)this.remove(a,
c,f);for(j in e)break;if(!j)a.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",function(){var a=jQuery.timer.global,c;for(c in a)for(var f=a[c],e=f.length;--e;)jQuery.timer.remove(f[e],c)});var S=/(\[\[[biu]*;[^;]*;[^\]]*\][^\]]*\])/g,$=/\[\[([biu]*);([^;]*);([^\]]*)\]([^\]]*)\]/g,T=/#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})/;g.json_stringify=function(a,c){var f="",e;c=c===y?1:c;switch(typeof a){case "function":f+=a;break;case "boolean":f+=a?"true":"false";break;case "object":if(a===null)f+=
"null";else if(a instanceof Array){f+="[";var j=a.length;for(e=0;e<j-1;++e)f+=g.json_stringify(a[e],c+1);f+=g.json_stringify(a[j-1],c+1)+"]"}else{f+="{";for(j in a)if(a.hasOwnProperty(j))f+='"'+j+'":'+g.json_stringify(a[j],c+1);f+="}"}break;case "string":j=a;var r={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};for(e in r)if(r.hasOwnProperty(e))j=j.replace(RegExp(e,"g"),r[e]);f+='"'+j+'"';break;case "number":f+=String(a)}f+=c>1?",":"";if(c==1)f=f.replace(/,([\]}])/g,"$1");
return f.replace(/([\[{]),/g,"$1")};g.fn.cmd=function(a){function c(){K.toggleClass("inverted")}function f(){j.focus();e.oneTime(1,function(){e.insert(j.val());j.blur();j.val("")})}var e=this;e.addClass("cmd");e.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');var j=g("<textarea/>").addClass("clipboard").appendTo(e);a.width&&e.width(a.width);var r,x,G=a.mask||false,m="",p=0,H,I=a.enabled,P,E,K=e.find(".cursor"),d=function(h){function u(t,v){if(v==
t.length){A.html(B(t));K.html("&nbsp;");J.html("")}else if(v===0){A.html("");K.html(B(t.slice(0,1)));J.html(B(t.slice(1)))}else{var k=B(t.slice(0,v));A.html(k);k=t.slice(v,v+1);K.html(k==" "?"&nbsp;":B(k));v==t.lenght-1?J.html(""):J.html(B(t.slice(v+1)))}}function F(t){return"<div>"+B(t)+"</div>"}function N(t){var v=J;g.each(t,function(k,l){v=g(F(l)).insertAfter(v).addClass("clear")})}function o(t){g.each(t,function(v,k){A.before(F(k))})}var A=K.prev(),J=K.next();return function(){var t=G?m.replace(/./g,
"*"):m,v;h.find("div").remove();A.html("");if(t.length>r-x-1||t.match(/\n/)){var k;if(t.match(/\n/)){var l=t.split("\n"),b=r-x-1;for(v=0;v<l.length-1;++v)l[v]+=" ";if(l[0].length>b){k=[l[0].substring(0,b)];k=k.concat(Q(l[0].substring(b),r))}else k=[l[0]];for(v=1;v<l.length;++v)if(l[v].length>r)k=k.concat(Q(l[v],r));else k.push(l[v])}else{k=t.substring(0,r-x-1);b=t.substring(r-x-1);k=[k].concat(Q(b,r))}b=k[0].length;if(p<b){u(k[0],p);N(k.slice(1))}else if(p==b){A.before(F(k[0]));u(k[1],0);N(k.slice(2))}else{v=
k.length;if(p<b){u(k[0],p);N(k.slice(1))}else if(p==b){A.before(F(k[0]));u(k[1],0);N(k.slice(2))}else{l=k.slice(-1)[0];var i=t.length-p;t=0;if(i<=l.length){o(k.slice(0,-1));t=l.length==i?0:l.length-i;u(l,t)}else if(v==3){A.before("<div>"+B(k[0])+"</div>");u(k[1],p-b-1);J.after('<div class="clear">'+B(k[2])+"</div>")}else{console&&console.dir(k);t=p;for(v=0;v<k.length;++v)if(t>k[v].length)t-=k[v].length;else break;b=k[v];if(t==b.length){t=0;b=k[++v]}u(b,t);o(k.slice(0,v));N(k.slice(v+1))}}}}else if(t===
""){A.html("");K.html("&nbsp;");J.html("")}else u(t,p)}}(e),L=function(){var h=e.find(".prompt");return function(){if(typeof H=="string"){x=H.length;h.html(B(H)+"&nbsp;")}else H(function(u){x=u.length;h.html(B(u)+"&nbsp;")})}}();g.extend(e,{name:function(h){if(h!==y){P=h;E=new ba(h)}else return P},history:function(){return E},set:function(h,u){if(h!==y){m=h;if(!u)p=m.length;d()}},insert:function(h,u){if(p==m.length)m+=h;else m=p===0?h+m:m.slice(0,p)+h+m.slice(p);u||(p+=h.length);d()},get:function(){return m},
commands:function(h){if(h)a.commands=h;else return h},destroy:function(){g(document.documentElement).unbind(".commandline");e.find(".prompt").remove()},prompt:function(h){if(h===y)return H;else{if(typeof h=="string"||typeof h=="function")H=h;else throw"prompt must be a function or string";L()}},position:function(h){if(typeof h=="number"){p=h<0?0:h>m.length?m.length:h;d()}else return p},resize:function(h){if(h)r=h;else{h=e.width();var u=K.innerWidth();r=Math.floor(h/u)}d()},enable:function(){if(!I){e.everyTime(500,
"blink",c);I=true}},isenabled:function(){return I},disable:function(){if(I){e.stopTime("blink",c);e.find(".cursor").removeClass("inverted");I=false}},mask:function(h){if(typeof h=="boolean"){G=h;d()}else return G}});e.name(a.name||"");H=a.prompt||">";L();if(a.enabled===y||a.enabled===true)e.enable();g(document.documentElement).keypress(function(h){var u;if(h.ctrlKey&&h.which==99)return true;if(a.keypress)u=a.keypress(h);if(u===y||u){if(I)if([38,32,13,0,8].has(h.which)&&h.keyCode!=123&&!(h.which==
38&&h.shiftKey))return false;else if(!h.ctrlKey&&!(h.altKey&&h.which==100)){e.insert(String.fromCharCode(h.which));return false}}else return u}).keydown(function(h){if(I){if(a.keydown&&a.keydown(h)===false)return false;var u;if(h.keyCode==13){E&&m&&E.append(m);E.last();h=m;e.set("");typeof H=="function"&&L();a.commands&&a.commands(h)}else if(h.which==32)e.insert(" ");else if(h.which==8){if(m!==""&&p>0){m=m.slice(0,p-1)+m.slice(p,m.length);--p;d()}}else if(h.which==9&&!(h.ctrlKey||h.altKey))e.insert("\t");
else if(h.which==46){if(m!==""&&p<m.length){m=m.slice(0,p)+m.slice(p+1,m.length);d()}return true}else if(E&&h.which==38||h.which==80&&h.ctrlKey)e.set(E.previous());else if(E&&h.which==40||h.which==78&&h.ctrlKey)e.set(E.next());else if(h.which==37||h.which==66&&h.ctrlKey)if(h.ctrlKey&&h.which!=66){u=p-1;h=0;for(m[u]==" "&&--u;u>0;--u)if(m[u]==" "&&m[u+1]!=" "){h=u+1;break}else if(m[u]=="\n"&&m[u+1]!="\n"){h=u;break}e.position(h)}else{if(p>0){--p;d()}}else if(h.which==39||h.which==70&&h.ctrlKey)if(h.ctrlKey&&
h.which!=70){m[p]==" "&&++p;h=m.slice(p).match(/\S[\n\s]{2,}|[\n\s]+\S?/);if(!h||h[0].match(/^\s+$/))p=m.length;else if(h[0][0]!=" ")p+=h.index+1;else{p+=h.index+h[0].length-1;h[0][h[0].length-1]!=" "&&--p}d()}else{if(p<m.length){++p;d()}}else if(h.which==123)return true;else if(h.which==36)e.position(0);else if(h.which==35)e.position(m.length);else if(h.ctrlKey||h.metaKey)if(h.shiftKey){if(h.which==84)return true}else if(h.which==65)e.position(0);else if(h.which==69)e.position(m.length);else if(h.which==
88||h.which==67||h.which==87||h.which==84)return true;else if(h.which==86){f();return true}else if(h.which==75)if(p===0)e.set("");else p!=m.length&&e.set(m.slice(0,p));else if(h.which==85)e.set("");else{if(h.which==17)return true}else if(h.altKey)h.which==68&&e.set(m.slice(0,p)+m.slice(p).replace(/[^ ]+ |[^ ]+$/,""),true);else return true;return false}});return e};g.jrpc=function(a,c,f,e,j,r){c=g.json_stringify({jsonrpc:"2.0",method:f,params:e,id:c});return g.ajax({url:a,data:c,success:j,error:r,
contentType:"application/json",dataType:"json",async:true,cache:false,type:"POST"})};O=/ {11}$/;var da=[["jQuery Terminal","(c) 2011 jcubic"],["JQuery Terminal Emulator v. 0.4","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,"")],["JQuery Terminal Emulator version version 0.4","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      _______                 ________                        __","     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /",
"/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\__/____/_/ \\__ / /_/____/_//_/ /_/ /_/  \\/\\__\\_\\___/","         \\/          /____/                                   ".replace(O,"")+"version 0.4","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      __ _____                     ________                              __","     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /",
"/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                          ".replace(O,"")+"version 0.4","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],ea=[],M=new function(a){var c=a?[a]:[],f=0;g.extend(this,{rotate:function(){if(c.length==1)return c[0];else{if(f==c.length-1)f=0;else++f;return c[f]}},length:function(){return c.length},
set:function(e){for(var j=c.length;j--;)if(c[j]===e){f=j;return}this.append(e)},front:function(){return c[f]},append:function(e){c.push(e)}})};g.fn.terminal=function(a,c){function f(){var b=g("<span>x</span>").appendTo(d),i=Math.floor(d.width()/b.width());b.remove();return i}function e(b,i){d.error("&#91;"+i+"&#93;: "+(typeof b=="string"?b:b.fileName+": "+b.message).replace(/\[/g,"&#91;").replace(/\]/g,"&#93;"));d.pause();typeof b.fileName=="string"&&g.get(b.fileName,function(n){d.resume();var s=
b.lineNumber-1;if(n=n.split("\n")[s]){n=n.replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");d.error("&#91;"+b.lineNumber+"&#93;: "+n)}})}function j(b,i){try{if(typeof i=="function")i(function(){});else if(typeof i!="string")throw b+" must be string or function";}catch(n){e(n,b.toUpperCase());return false}return true}function r(){var b=d.prop?d.prop("scrollHeight"):d.attr("scrollHeight");d.scrollTop(b)}function x(b){b=typeof b=="string"?b:String(b);var i;if(b.length>F){b=b.split("\n");i=g("<div></div>");
for(var n=b.length,s=0;s<n;++s)if(b[s]===""||b[s]=="\r")i.append("<div>&nbsp;</div>");else if(b[s].length>F){var q=Q(b[s],F);s=0;for(n=q.length;s<n;++s){var z=/\[\[[biu]*;[^;]*;[^\]]*\]/,w=q[s].match(z);if(w&&!q[s].match(S)){for(var C=s+1;C<n;++C)if(q[C].match(/\]/)){for(var D=s+1;D<=C;++D){z=/^\[\[[biu]*;[^;]*;[^\]]*\]/;q[D].match(z)||(q[D]=w[0]+q[D])}break}q[s]+="]"}}g.each(q,function(ga,fa){g("<div/>").html(B(fa)).appendTo(i)})}else g("<div/>").html(B(b[s])).appendTo(i)}else i=g("<div/>").html(B(b));
h.append(i);i.width("100%");r();return i}function G(b,i){var n=1,s=function(q,z){i.pause();g.jrpc(b,n++,q,z,function(w){if(w.error)i.error("&#91;RPC&#93; "+w.error.message);else if(typeof w.result=="string")i.echo(w.result);else if(w.result instanceof Array)i.echo(w.result.join(" "));else if(typeof w.result=="object"){var C="",D;for(D in w.result)if(w.result.hasOwnProperty(D))C+=D+": "+w.result[D]+"\n";i.echo(C)}i.resume()},function(w,C){i.error("&#91;AJAX&#93; "+C+" - Server reponse is: \n"+w.responseText);
i.resume()})};return function(q,z){if(q!==""){var w,C;if(q.match(/[^ ]* /)){q=q.split(/ +/);w=q[0];C=q.slice(1)}else{w=q;C=[]}if(!o.login||w=="help")s(w,C);else{var D=z.token();D?s(w,[D].concat(C)):z.error("&#91;AUTH&#93; Access denied (no token)")}}}}function m(b){var i=l.prompt();if(l.mask())b=b.replace(/./g,"*");typeof i=="function"?i(function(n){d.echo(n+" "+b)}):d.echo(i+" "+b)}function p(b){try{var i=k.top();if(b=="exit"&&o.exit)if(k.size()==1)o.login?I():d.echo("You can exit from main interpeter");
else d.pop("exit");else{m(b);b=="clear"&&o.clear?d.clear():i.eval(b,d)}}catch(n){e(n,"USER");console.log(n.stack);d.resume();throw n;}}function H(){var b=null;l.prompt("login:");o.history&&l.history().disable();l.commands(function(i){try{m(i);if(b){l.mask(false);d.pause();o.login(b,i,function(s){if(s){var q=o.name;q=q?"_"+q:"";g.Storage.set("token"+q,s);g.Storage.set("login"+q,b);l.commands(p);E()}else{d.error("Wrong password try again");l.prompt("login:");b=null}d.resume();o.history&&l.history().enable()})}else{b=
i;l.prompt("password:");l.mask(true)}}catch(n){e(n,"LOGIN",d);throw n;}})}function I(){var b=o.name;b=b?"_"+b:"";g.Storage.remove("token"+b,null);g.Storage.remove("login"+b,null);o.history&&l.history().disable();H()}function P(){var b=k.top(),i="";if(b.name!==y&&b.name!=="")i+=b.name+"_";i+=u;l.name(i);l.prompt(b.prompt);o.history&&l.history().enable();l.set("");if(typeof b.onStart=="function")b.onStart(d)}function E(){P();if(c.greetings===y)d.echo(d.signature);else c.greetings&&d.echo(c.greetings);
if(typeof o.onInit=="function")o.onInit(d)}function K(b){if(!d.paused()){if(o.keydown&&o.keydown(b,d)===false)return false;if(b.which!=9)J=0;if(b.which==68&&b.ctrlKey){if(o.exit)if(l.get()==="")if(k.size()>1||o.login!==y)d.pop("");else{d.resume();d.echo("")}else d.set_command("");b.preventDefault()}else if(o.tabcompletion&&b.which==9){++J;b=l.get();if(!b.match(" ")){for(var i=RegExp("^"+b),n=k.top().command_list,s=[],q=n.length;q--;)i.test(n[q])&&s.push(n[q]);if(s.length==1)d.set_command(s[0]);else if(s.length>
1)if(J>=2){m(b);d.echo(s.join("\t"))}}return false}else if(b.which==86&&b.ctrlKey){d.oneTime(1,function(){r()});return true}else if(b.which==9&&b.ctrlKey){M.length()>1&&d.focus(false);b.preventDefault()}else if(b.which==34)d.scroll(d.height());else b.which==33?d.scroll(-d.height()):d.attr({scrollTop:d.attr("scrollHeight")})}}var d=this,L=[],h,u=M.length(),F,N=[],o={name:"",prompt:">",history:true,exit:true,clear:true,enabled:true,login:null,tabcompletion:false,onInit:null,onExit:null,keypress:null,
keydown:null};if(c){c.width&&d.width(c.width);c.height&&d.height(c.height);g.extend(o,c)}var A=!o.enabled;if(d.length===0)throw'Sorry, but terminal said that "'+d.selector+'" is not valid selector';d.ajaxSend(function(b,i){ea.push(i)});if(d.data("terminal"))return d.data("terminal");h=g("<div>").addClass("terminal-output").appendTo(d);d.addClass("terminal").append("<div/>");g.extend(d,{clear:function(){h.html("");l.set("");L=[];d.attr({scrollTop:0});return d},paused:function(){return A},pause:function(){if(l){d.disable();
l.hide()}return d},resume:function(){if(l){d.enable();l.show();r()}return d},cols:function(){return F},rows:function(){return L.length},history:function(){return l.history().data()},next:function(){if(M.length()==1)return d;else{var b=d.offset().top;d.height();d.scrollTop();var i=d,n=g(window).scrollTop(),s=n+g(window).height(),q=g(i).offset().top;if(q+g(i).height()>=n&&q<=s){M.front().disable();b=M.rotate().enable();i=b.offset().top-50;g("html,body").animate({scrollTop:i},500);return b}else{d.enable();
g("html,body").animate({scrollTop:b-50},500);return d}}},focus:function(b){d.oneTime(1,function(){if(M.length()==1)b===false?d.disable():d.enable();else if(b===false)d.next();else{M.front().disable();M.set(d);d.enable()}});return d},enable:function(){F===y&&d.resize();if(A)if(l){l.enable();A=false}return d},disable:function(){if(l){A=true;l.disable()}return d},enabled:function(){return A},signature:function(){var b=d.cols();b=b<15?null:b<35?0:b<55?1:b<64?2:b<75?3:4;return b!==null?da[b].join("\n")+
"\n":""},version:function(){return"0.4"},get_command:function(){return l.get()},insert:function(b){l.insert(b);return d},set_prompt:function(b){j("prompt",b)&&l.prompt(b);return d},set_command:function(b){l.set(b);return d},set_mask:function(b){l.mask(b);return d},get_output:function(){return g.map(L,function(b,i){return typeof i=="function"?i():i}).get().join("\n")},resize:function(b,i){if(b&&i){d.width(b);d.height(i)}F=f();l.resize(F);var n=h.detach();h.html("");g.each(L,function(s,q){x(typeof q==
"function"?q():q)});d.prepend(n);r();return d},echo:function(b){L.push(b);return x(typeof b=="function"?b():b)},error:function(b){d.echo("[[;#f00;]"+b+"]")},scroll:function(b){var i;if(d.prop){b>d.prop("scrollTop")&&b>0&&d.prop("scrollTop",0);i=d.prop("scrollTop");d.prop("scrollTop",i+b)}else{b>d.attr("scrollTop")&&b>0&&d.attr("scrollTop",0);i=d.attr("scrollTop");d.attr("scrollTop",i+b)}return d},logout:o.login?function(){for(;k.size()>1;)k.pop();I();return d}:function(){throw"You don't have login function";
},token:o.login?function(){var b=o.name;return g.Storage.get("token"+(b?"_"+b:""))}:null,login_name:o.login?function(){var b=o.name;return g.Storage.get("login"+(b?"_"+b:""))}:null,name:function(){return o.name},push:function(b,i){if(!i.prompt||j("prompt",i.prompt)){if(typeof b=="string")b=G(i.eval,d);k.push(g.extend({eval:b},i));P()}return d},pop:function(b){b!==y&&m(b);if(k.top().name===o.name){if(o.login){I();if(typeof o.onExit=="function")o.onExit(d)}}else{b=k.pop();P();if(typeof b.onExit=="function")b.onExit(d)}return d}});
var J=0,t;switch(typeof a){case "string":t=a;a=G(a,d);break;case "object":for(var v in a)N.push(v);a=function b(i){return function(n){if(n!==""){n=n.split(/ +/);var s=n[0],q=n.slice(1);n=i[s];var z=typeof n;if(z=="function")n.apply(d,q);else if(z=="object"||z=="string"){q=[];if(z=="object"){for(var w in n)q.push(w);n=b(n)}d.push(n,{prompt:s+">",name:s,command_list:q})}else d.echo("[[;#f00;]Command '"+s+"' Not Found]")}}}(a);break;case "function":break;default:throw'Unknow object "'+String(a)+'" passed as eval';
}if(t&&typeof o.login=="string"||t)o.login=function(b){var i=1;return function(n,s,q){d.pause();g.jrpc(t,i++,b,[n,s],function(z){d.resume();!z.error&&z.result?q(z.result):q(null)},function(z,w){d.resume();d.error("&#91;AJAX&#92; Response: "+w+"\n"+z.responseText)})}}(typeof o.login=="boolean"?"login":o.login);if(j("prompt",o.prompt)){var k=new aa({name:o.name,eval:a,prompt:o.prompt,command_list:N,greetings:o.greetings}),l=d.find(".terminal-output").next().cmd({prompt:o.prompt,history:o.history,width:"100%",
keydown:K,keypress:o.keypress?function(b){return o.keypress(b,d)}:null,commands:p});d.livequery(function(){d.resize()});M.append(d);o.enabled===true?d.focus():d.disable();g(window).resize(d.resize);d.click(function(){d.focus()});d.token&&!d.token()&&d.login_name&&!d.login_name()?H():E();typeof g.fn.init.prototype.mousewheel==="function"&&d.mousewheel(function(b,i){i>0?d.scroll(-40):d.scroll(40);return false},true)}d.data("terminal",d);return d}})(jQuery);
