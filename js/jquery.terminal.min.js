/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                              version 0.3
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 LiveQuery plugin Dual MIT and GPL
 Copyright (c) 2008 Brandon Aaron (http://brandonaaron.net)

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

 Date: Fri, 25 Feb 2011 23:20:25 +0000
*/
Array.prototype.has=function(g){for(var u=this.length;u--;)if(this[u]==g)return true;return false};
(function(g,u){function S(b,a){var d;if(typeof b==="string"&&typeof a==="string"){localStorage[b]=a;return true}else if(typeof b==="object"&&typeof a==="undefined"){for(d in b)if(b.hasOwnProperty(d))localStorage[d]=b[d];return true}return false}function N(b,a){var d,h;d=new Date;d.setTime(d.getTime()+31536E6);d="; expires="+d.toGMTString();if(typeof b==="string"&&typeof a==="string"){document.cookie=b+"="+a+d+"; path=/";return true}else if(typeof b==="object"&&typeof a==="undefined"){for(h in b)if(b.hasOwnProperty(h))document.cookie=
h+"="+b[h]+d+"; path=/";return true}return false}function T(b){return localStorage[b]}function U(b){var a,d,h;b+="=";a=document.cookie.split(";");for(d=0;d<a.length;d++){for(h=a[d];h.charAt(0)===" ";)h=h.substring(1,h.length);if(h.indexOf(b)===0)return h.substring(b.length,h.length)}return null}function V(b){return delete localStorage[b]}function W(b){return N(b,"",-1)}function O(b,a){var d=[],h=b.length;if(h<a)return[b];for(var j=0;j<h;j+=a)d.push(b.substring(j,j+a));return d}function w(b){if(typeof b==
"string"){b=b.replace(/&/g,"&amp;");b=b.replace(/</g,"&lt;").replace(/>/g,"&gt;");b=b.replace(/\n/g,"<br/>");b=b.replace(/ /g,"&nbsp;");b=b.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");var a=b.split(P);if(a.length>1){b=g.map(a,function(d){return d[0]=="["?d.replace(X,function(h,j,o,l,m){h="";if(j.indexOf("b")!=-1)h+="font-weight:bold;";if(j.indexOf("u")!=-1)h+="text-decoration:underline;";if(j.indexOf("i")!=-1)h+="font-style:italic; ";if(o.match(Q))h+="color:"+o+";";if(l.match(Q))h+="background-color:"+
l;return b='<span style="'+h+'">'+m+"</span>"}):"<span>"+d+"</span>"}).join("");console.log(b.split(P))}return b}else return""}function R(b){var a=b instanceof Array?b:b?[b]:[],d=0;g.extend(this,{left:function(){if(d===0)d=a.length-1;else--d;return a[d]},right:function(){if(d==a.length-1)d=0;else++d;return a[d]},current:function(){return a[d]},data:function(){return a},reset:function(){d=0},append:function(h){a.push(h);this.reset()}})}function Y(b){var a=b?[b]:[];g.extend(this,{size:function(){return a.length},
pop:function(){if(a.length===0)return null;else{var d=a[a.length-1];a=a.slice(0,a.length-1);return d}},push:function(d){a=a.concat([d]);return d},top:function(){return a.length>0?a[a.length-1]:null}})}function Z(b){var a=true;if(typeof b==="string"&&b!=="")b+="_";var d=g.Storage.get(b+"commands"),h=new R(d?eval("("+d+")"):[""]);g.extend(this,{append:function(j){if(a&&h.current()!=j){h.append(j);g.Storage.set(b+"commands",g.json_stringify(h.data()))}},data:function(){return h.data()},next:function(){return h.right()},
last:function(){h.reset()},previous:function(){return h.left()},clear:function(){h=new R;g.Storage.remove(b+"commands")},enable:function(){a=true},disable:function(){a=false}})}g.extend(g.fn,{livequery:function(b,a,d){var h=this,j;if(g.isFunction(b)){d=a;a=b;b=u}g.each(g.livequery.queries,function(o,l){if(h.selector==l.selector&&h.context==l.context&&b==l.type&&(!a||a.$lqguid==l.fn.$lqguid)&&(!d||d.$lqguid==l.fn2.$lqguid))return(j=l)&&false});j=j||new g.livequery(this.selector,this.context,b,a,d);
j.stopped=false;j.run();return this},expire:function(b,a,d){var h=this;if(g.isFunction(b)){d=a;a=b;b=u}g.each(g.livequery.queries,function(j,o){if(h.selector==o.selector&&h.context==o.context&&(!b||b==o.type)&&(!a||a.$lqguid==o.fn.$lqguid)&&(!d||d.$lqguid==o.fn2.$lqguid)&&!this.stopped)g.livequery.stop(o.id)});return this}});g.livequery=function(b,a,d,h,j){this.selector=b;this.context=a||document;this.type=d;this.fn=h;this.fn2=j;this.elements=[];this.stopped=false;this.id=g.livequery.queries.push(this)-
1;h.$lqguid=h.$lqguid||g.livequery.guid++;if(j)j.$lqguid=j.$lqguid||g.livequery.guid++;return this};g.livequery.prototype={stop:function(){var b=this;if(this.type)this.elements.unbind(this.type,this.fn);else this.fn2&&this.elements.each(function(a,d){b.fn2.apply(d)});this.elements=[];this.stopped=true},run:function(){if(!this.stopped){var b=this,a=this.elements,d=g(this.selector,this.context),h=d.not(a);this.elements=d;if(this.type){h.bind(this.type,this.fn);a.length>0&&g.each(a,function(j,o){g.inArray(o,
d)<0&&g.event.remove(o,b.type,b.fn)})}else{h.each(function(){b.fn.apply(this)});this.fn2&&a.length>0&&g.each(a,function(j,o){g.inArray(o,d)<0&&b.fn2.apply(o)})}}}};g.extend(g.livequery,{guid:0,queries:[],queue:[],running:false,timeout:null,checkQueue:function(){if(g.livequery.running&&g.livequery.queue.length)for(var b=g.livequery.queue.length;b--;)g.livequery.queries[g.livequery.queue.shift()].run()},pause:function(){g.livequery.running=false},play:function(){g.livequery.running=true;g.livequery.run()},
registerPlugin:function(){g.each(arguments,function(b,a){if(g.fn[a]){var d=g.fn[a];g.fn[a]=function(){var h=d.apply(this,arguments);g.livequery.run();return h}}})},run:function(b){if(b!=u)g.inArray(b,g.livequery.queue)<0&&g.livequery.queue.push(b);else g.each(g.livequery.queries,function(a){g.inArray(a,g.livequery.queue)<0&&g.livequery.queue.push(a)});g.livequery.timeout&&clearTimeout(g.livequery.timeout);g.livequery.timeout=setTimeout(g.livequery.checkQueue,20)},stop:function(b){b!=u?g.livequery.queries[b].stop():
g.each(g.livequery.queries,function(a){g.livequery.queries[a].stop()})}});g.livequery.registerPlugin("append","prepend","after","before","wrap","attr","removeAttr","addClass","removeClass","toggleClass","empty","remove");g(function(){g.livequery.play()});var $=g.prototype.init;g.prototype.init=function(b,a){var d=$.apply(this,arguments);if(b&&b.selector){d.context=b.context;d.selector=b.selector}if(typeof b=="string"){d.context=a||document;d.selector=b}return d};g.prototype.init.prototype=g.prototype;
var J=typeof window.localStorage!=="undefined";g.extend({Storage:{set:J?S:N,get:J?T:U,remove:J?V:W}});jQuery.fn.extend({everyTime:function(b,a,d,h,j){return this.each(function(){jQuery.timer.add(this,b,a,d,h,j)})},oneTime:function(b,a,d){return this.each(function(){jQuery.timer.add(this,b,a,d,1)})},stopTime:function(b,a){return this.each(function(){jQuery.timer.remove(this,b,a)})}});jQuery.extend({timer:{guid:1,global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},
timeParse:function(b){if(b==u||b==null)return null;var a=this.regex.exec(jQuery.trim(b.toString()));return a[2]?parseInt(a[1],10)*(this.powers[a[2]]||1):b},add:function(b,a,d,h,j,o){var l=0;if(jQuery.isFunction(d)){j||(j=h);h=d;d=a}a=jQuery.timer.timeParse(a);if(!(typeof a!="number"||isNaN(a)||a<=0)){if(j&&j.constructor!=Number){o=!!j;j=0}j=j||0;o=o||false;if(!b.$timers)b.$timers={};b.$timers[d]||(b.$timers[d]={});h.$timerID=h.$timerID||this.guid++;var m=function(){if(!(o&&this.inProgress)){this.inProgress=
true;if(++l>j&&j!==0||h.call(b,l)===false)jQuery.timer.remove(b,d,h);this.inProgress=false}};m.$timerID=h.$timerID;b.$timers[d][h.$timerID]||(b.$timers[d][h.$timerID]=window.setInterval(m,a));this.global[d]||(this.global[d]=[]);this.global[d].push(b)}},remove:function(b,a,d){var h=b.$timers,j;if(h){if(a){if(h[a]){if(d){if(d.$timerID){window.clearInterval(h[a][d.$timerID]);delete h[a][d.$timerID]}}else for(d in h[a]){window.clearInterval(h[a][d]);delete h[a][d]}for(j in h[a])break;if(!j){j=null;delete h[a]}}}else for(a in h)this.remove(b,
a,d);for(j in h)break;if(!j)b.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",function(){var b=jQuery.timer.global,a;for(a in b)for(var d=b[a],h=d.length;--h;)jQuery.timer.remove(d[h],a)});var P=/(\[\[[biu]*;[^;]*;[^\]]*\][^\]]*\])/g,X=/\[\[([biu]*);([^;]*);([^\]]*)\]([^\]]*)\]/g,Q=/#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})/;g.json_stringify=function(b,a){var d="";a=a===u?1:a;switch(typeof b){case "function":d+=b;break;case "boolean":d+=b?"true":"false";break;case "object":if(b===null)d+=
"null";else if(b instanceof Array){d+="[";for(var h=b.length,j=0;j<h-1;++j)d+=g.json_stringify(b[j],a+1);d+=g.json_stringify(b[h-1],a+1)+"]"}else{d+="{";for(h in b)if(b.hasOwnProperty(h))d+='"'+h+'":'+g.json_stringify(b[h],a+1);d+="}"}break;case "string":h=b;var o={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};for(j in o)if(o.hasOwnProperty(j))h=h.replace(RegExp(j,"g"),o[j]);d+='"'+h+'"';break;case "number":d+=String(b)}d+=a>1?",":"";if(a==1)d=d.replace(/,([\]}])/g,"$1");
return d.replace(/([\[{]),/g,"$1")};g.fn.cmd=function(b){var a=this;a.addClass("cmd");a.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');var d=g("<textarea/>").addClass("clipboard").appendTo(a);b.width&&a.width(b.width);var h,j,o=b.mask||false,l="",m=0,z,F=b.enabled,L,x,H=function(){var f=a.find(".cursor");return function(){f.toggleClass("inverted")}}(),M=a.find(".cursor"),e=function(f){function p(k,c){if(c==k.length){A.html(w(k));y.html("&nbsp;");
v.html("")}else if(c===0){A.html("");y.html(w(k.slice(0,1)));v.html(w(k.slice(1)))}else{var i=w(k.slice(0,c));A.html(i);i=k.slice(c,c+1);y.html(i==" "?"&nbsp;":w(i));c==k.lenght-1?v.html(""):v.html(w(k.slice(c+1)))}}function B(k){var c=v;g.each(k,function(i,q){c=g("<div>"+w(q)+"</div>").insertAfter(c)})}function n(k){g.each(k,function(c,i){A.before("<div>"+w(i)+"</div>")})}var y=f.find(".cursor"),A=y.prev(),v=y.next();return function(){var k=o?l.replace(/./g,"*"):l;f.find("div").remove();A.html("");
if(k.length>h-j-1){var c;c=k.substring(0,h-j-1);var i=k.substring(h-j-1);c=[c].concat(O(i,h));i=c[0].length;if(m<i){p(c[0],m);B(c.slice(1))}else{var q=c.length;if(m<=i){p(c[0],m);B(c.slice(1))}else{var r=c.slice(-1)[0];k=k.length-m;if(k<r.length){n(c.slice(0,-1));p(r,r.length-k-1)}else if(q==3){A.before("<div>"+w(c[0])+"</div>");p(c[1],m-i-1);v.after("<div>"+w(c[2])+"</div>")}else{k=Math.floor((m+j)/h);q=c[k];i=(m-i-1)%h;w(q.slice(0,i));p(q,i);n(c.slice(0,k));B(c.slice(k+1))}}}}else if(k===""){A.html("");
y.html("&nbsp;");v.html("")}else p(k,m)}}(a),D=function(){var f=a.find(".prompt");return function(){if(typeof z=="string"){j=z.length;f.html(w(z)+"&nbsp;")}else z(function(p){j=p.length;f.html(w(p)+"&nbsp;")})}}();g.extend(a,{name:function(f){if(f!==u){L=f;x=new Z(f)}else return L},history:function(){return x},set:function(f,p){if(f!==u){l=f;if(!p)m=l.length;e()}},insert:function(f,p){if(m==l.length)l+=f;else l=m===0?f+l:l.slice(0,m)+f+l.slice(m);p||(m+=f.length);e()},get:function(){return l},commands:function(f){if(f)b.commands=
f;else return f},destroy:function(){g(document.documentElement).unbind(".commandline");a.find(".prompt").remove()},prompt:function(f){if(f===u)return z;else{if(typeof f=="string"||typeof f=="function")z=f;else throw"prompt must be a function or string";D()}},position:function(f){if(typeof f=="number"){m=f;e()}else return m},resize:function(f){if(f)h=f;else{f=a.width();var p=M.innerWidth();h=Math.floor(f/p)}e()},enable:function(){if(!this.isenabled()){a.everyTime(500,"blink",H);F=true}},isenabled:function(){return F},
disable:function(){if(this.isenabled()){a.stopTime("blink",H);a.find(".cursor").removeClass("inverted");F=false}},mask:function(f){if(typeof f=="boolean"){o=f;e()}else return o}});a.name(b.name||"");z=b.prompt||">";D();b.enabled===u&&!b.enabled&&a.enable();g(document.documentElement).keypress(function(f){if(F){var p;if(b.keypress)p=b.keypress(f);if(p===u||p)if([38,32,13,40,0,8].has(f.which)&&f.keyCode!=123&&!(f.which==40&&f.shiftKey||f.which==38&&f.shiftKey))return false;else if(!f.ctrlKey&&!(f.altKey&&
f.which==100)){a.insert(String.fromCharCode(f.which));if(f.which==45||f.shiftKey&&f.which==43)return false}}if(f.which==100&&f.ctrlKey)return false}).keydown(function(f){if(b.keydown&&b.keydown(f)===false)return false;if(F){var p;if(f.keyCode==13){x&&l&&x.append(l);x.last();f=l;a.set("");typeof z=="function"&&D();b.commands&&b.commands(f)}else if(f.which==32)a.insert(" ");else if(f.which==8){if(l!==""&&m>0){l=l.slice(0,m-1)+l.slice(m,l.length);--m;e()}}else if(f.which==9)a.insert("\t");else if(f.which==
46||f.which==68&&f.ctrlKey){if(l!==""&&m<l.length){l=l.slice(0,m)+l.slice(m+1,l.length);e()}return true}else if(x&&f.which==38||f.which==80&&f.ctrlKey)a.set(x.previous());else if(x&&f.which==40||f.which==78&&f.ctrlKey)a.set(x.next());else if(f.which==27)a.set("");else if(f.which==37||f.which==66&&f.ctrlKey)if(f.ctrlKey&&f.which!=66){p=m-1;f=0;for(l[p]==" "&&--p;p>0;--p)if(l[p]==" "&&l[p+1]!=" "){f=p+1;break}a.position(f)}else{if(m>0){--m;e()}}else if(f.which==39||f.which==70&&f.ctrlKey)if(f.ctrlKey&&
f.which!=70){l[m]==" "&&++m;f=l.slice(m).match(/[^ ] {2,}| +[^ ]?/);if(!f||f[0].match(/^ +$/))m=l.length;else if(f[0][0]!=" ")m+=f.index+1;else{m+=f.index+f[0].length-1;f[0][f[0].length-1]!=" "&&--m}e()}else{if(m<l.length){++m;e()}}else if(f.which==123)return true;else if(f.which==36)a.position(0);else if(f.which==35)a.position(l.length);else if(f.metaKey)if(f.shiftKey){if(f.which==84)return true}else{if(!f.altKey)if(f.which==65)a.position(0);else if(f.which==69)a.position(l.length);else if(f.which==
88||f.which==67||f.which==87||f.which==84)return true;else if(f.which==86){d.focus();window.setTimeout(function(){a.insert(d.val());d.blur();d.val("")},1);return true}else if(f.which==75)if(m===0)a.set("");else m!=l.length&&a.set(l.slice(0,m));else if(f.which==17)return true}else if(f.altKey)f.which==68&&a.set(l.slice(0,m)+l.slice(m).replace(/[^ ]+ |[^ ]+$/,""),true);else return true;return false}else if(f.altKey&&f.which==68||f.ctrlKey&&[65,66,68,69,80,78,70].has(f.which)||[35,36,37,38,39,40].has(f.which))return false});
return a};var K=[];g.jrpc=function(b,a,d,h,j,o){a=g.json_stringify({jsonrpc:"2.0",method:d,params:h,id:a});return g.ajax({url:b,data:a,success:j,error:o,contentType:"application/json",dataType:"json",beforeSend:function(l){K.push(l)},async:true,cache:false,type:"POST"})};J=/ {11}$/;var aa=[["jQuery Terminal","(c) 2011 jcubic"],["JQuery Terminal Emulator v. 0.3","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,"")],["JQuery Terminal Emulator version version 0.3","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],
["      _______                 ________                        __","     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /","/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\___/____/_/_\\_ / /_/____/_//_/ /_/_/_/  \\/\\__\\_\\___/","         \\/          /____/                                   ".replace(J,"")+"version 0.3","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      __ _____                     ________                              __",
"     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /","/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                          ".replace(J,"")+"version 0.3","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],G=new function(b){var a=
b?[b]:[],d=0;g.extend(this,{rotate:function(){if(a.length==1)return a[0];else{if(d==a.length-1)d=0;else++d;return a[d]}},length:function(){return a.length},set:function(h){for(var j=a.length;j--;)if(a[j]===h){d=j;return}this.append(h)},front:function(){return a[d]},append:function(h){a.push(h)}})};K=[];g.fn.terminal=function(b,a){function d(){var c=g("<span>x</span>").appendTo(e),i=Math.floor(e.width()/c.width());c.remove();return i}function h(c,i){if(typeof c=="string")e.echo("["+i+"]: "+c).addClass("error");
else{e.echo("["+i+"]: "+c.fileName+": "+c.message).addClass("error");e.pause();g.get(c.fileName,function(q){e.resume();var r=c.lineNumber-1;e.echo("["+c.lineNumber+"]"+q.split("\n")[r]).addClass("error")})}}function j(c,i){try{if(typeof i=="function")i(function(){});else if(typeof i!="string")throw c+" must be string or function";}catch(q){h(q,c.toUpperCase());return false}return true}function o(c){c.scrollTop(e.attr("scrollHeight"))}function l(c){c=typeof c=="string"?c:String(c);var i;if(c.length>
B){c=c.split("\n");i=g("<div></div>");for(var q=c.length,r=0;r<q;++r)if(c[r]===""||c[r]=="\r")i.append("<div>&nbsp;</div>");else if(c[r].length>B){var t=O(c[r],B);g.each(t,function(C,s){g("<div/>").html(w(s)).appendTo(i)})}else g("<div/>").html(w(c[r])).appendTo(i)}else i=g("<div/>").html(w(c));f.append(i);i.width("100%");o(e);return i}function m(c,i){var q=1,r=function(t,C){i.pause();g.jrpc(c,q++,t,C,function(s){if(s.error)i.error("[RPC] "+s.error.message);else if(typeof s.result=="string")i.echo(s.result);
else if(s.result instanceof Array)i.echo(s.result.join(" "));else if(typeof s.result=="object"){var E="",I;for(I in s.result)if(s.result.hasOwnProperty(I))E+=I+": "+s.result[I]+"\n";i.echo(E)}i.resume()},function(s,E){i.error("[AJAX] "+E+" - Server reponse is: \n"+s.responseText);i.resume()})};return function(t,C){if(t!==""){var s,E;if(t.match(/[^ ]* /)){t=t.split(/ */);s=t[0];E=t.slice(1)}else{s=t;E=[]}if(!n.login||s=="help")r(s,E);else{var I=C.token();I?r(s,[I].concat(E)):C.error("[AUTH] Access denied (no token)")}}}}
function z(c){var i=k.prompt();if(k.mask())c=c.replace(/./g,"*");typeof i=="function"?i(function(q){e.echo(q+" "+c)}):e.echo(i+" "+c)}function F(c){try{var i=v.top();if(c=="exit"&&n.exit)if(v.size()==1)n.login?x():e.echo("You can exit from main interpeter");else e.pop("exit");else{z(c);c=="clear"&&n.clear?e.clear():i.eval(c,e)}}catch(q){h(q,"USER");throw q;}}function L(){var c=null;k.prompt("login:");n.history&&k.history().disable();k.commands(function(i){try{z(i);if(c){k.mask(false);e.pause();n.login(c,
i,function(r){if(r){var t=n.name;t=t?"_"+t:"";g.Storage.set("token"+t,r);g.Storage.set("login"+t,c);k.commands(F);H();e.echo(a.greetings||e.signature)}else{e.error("Wrong password try again");k.prompt("login:");c=null}e.resume();n.history&&k.history().enable()})}else{c=i;k.prompt("password:");k.mask(true)}}catch(q){h(q,"LOGIN",e);throw q;}})}function x(){var c=n.name;c=c?"_"+c:"";g.Storage.remove("token"+c,null);g.Storage.remove("login"+c,null);n.history&&k.history().disable();L()}function H(){var c=
v.top(),i="";if(c.name!==u&&c.name!=="")i+=c.name+"_";i+=p;k.name(i);k.prompt(c.prompt);n.history&&k.history().enable();k.set("");if(typeof c.onStart=="function")c.onStart(e)}function M(c){if(e.paused()){if(c.which==100&&c.ctrlKey){console.log(K);for(c=K.length;c--;){var i=K[c];if(4!=i.readyState)try{i.abort()}catch(q){e.error("error in aborting ajax")}}e.resume();return false}}else{if(n.keypress&&n.keypress(c)===false)return false;if(c.which==100&&c.ctrlKey){if(n.exit&&k.get()==="")n.name==v.top().name&&
!n.login?e.echo("you can't exit from top interpreter"):e.pop("");return false}else if(c.charCode==118&&c.ctrlKey){window.setTimeout(function(){e.attr({scrollTop:e.attr("scrollHeight")})},1);return true}else if(c.which==34)e.scroll(e.height());else c.which==33?e.scroll(-e.height()):e.attr({scrollTop:e.attr("scrollHeight")})}}var e=this,D=[],f,p=G.length(),B,n={name:null,prompt:">",history:true,exit:true,clear:true,enabled:true,login:null};if(a){a.width&&e.width(a.width);a.height&&e.height(a.height);
g.extend(n,a)}var y=!n.enabled;if(e.length===0)throw'Sorry, but terminal said that "'+e.selector+'" is not valid selector';if(e.data("terminal")){e.ajaxSend(function(c,i){K.push(i)});return e.data("terminal")}f=g("<div>").addClass("terminal-output").appendTo(e);e.addClass("terminal").append("<div/>");g.extend(e,{clear:function(){f.html("");k.set("");D=[];e.attr({scrollTop:0});a.greetings=null;return e},paused:function(){return y},pause:function(){if(k){e.disable();k.hide()}return e},resume:function(){if(k){e.enable();
k.show();o(e)}return e},cols:function(){return B},rows:function(){return D.length},history:function(){return k.history().data()},next:function(){if(G.length()==1)return e;else{G.front().disable();return G.rotate().enable()}},focus:function(c){e.oneTime(1,function(){if(G.length()==1)c===false?e.disable():e.enable();else if(c===false)e.next();else{G.front().disable();G.set(e);e.enable()}});return e},enable:function(){B===u&&e.resize();if(y)if(k){k.enable();y=false}return e},disable:function(){if(!y)if(k){y=
true;k.disable()}return e},enabled:function(){return y},signature:function(){var c=e.cols();c=c<15?null:c<35?0:c<55?1:c<64?2:c<75?3:4;return c!==null?aa[c].join("\n"):""},get_command:function(){return k.get()},insert:function(c){k.insert(c);return e},set_prompt:function(c){j("prompt",c)&&k.prompt(c);return e},set_command:function(c){k.set(c);return e},set_mask:function(c){k.mask(c);return e},get_output:function(){return D.join("\n")},resize:function(c,i){if(c&&i){e.width(c);e.height(i)}B=d();k.resize(B);
f.html("");g.each(D,function(q,r){l(typeof r=="function"?r():r)});o(e);return e},echo:function(c){D.push(c);return l(typeof c=="function"?c():c)},error:function(c){return e.echo(c).addClass("error")},scroll:function(c){c>e.attr("scrollTop")&&c>0&&e.attr("scrollTop",0);var i=e.attr("scrollTop");e.attr("scrollTop",i+c);return e},logout:n.login?function(){for(;v.size()>1;)v.pop();x();return e}:function(){throw"You don't have login function";},token:n.login?function(){var c=n.name;return g.Storage.get("token"+
(c?"_"+c:""))}:null,login_name:n.login?function(){var c=n.name;return g.Storage.get("login_"+(c?"_"+c:""))}:null,name:function(){return n.name},push:function(c,i){if(!i.prompt||j("prompt",i.prompt)){if(typeof c=="string")c=m(i.eval,e);v.push({name:i.name,eval:c,prompt:i.prompt,login:i.login,onStart:i.onStart,onExit:i.onExit});H()}return e},pop:function(c){c!==u&&z(c);if(v.top().name===n.name){if(n.login){x();if(typeof n.onAfterLogout=="function")n.onAfterLogout(e)}}else{c=v.pop();H();if(typeof c.onExit==
"function")c.onExit(e)}return e}});var A;switch(typeof b){case "string":A=b;b=m(b,e);break;case "object":b=function(c){return function(i){if(i!=""){i=i.split(/ */);var q=i[0];i=i.slice(1);var r=c[q];typeof r=="function"?r.apply(e,i):e.echo("Command '"+q+"' Not Found")}}}(b)}if(A&&typeof n.login=="string"||A)n.login=function(c){var i=1;return function(q,r,t){e.pause();g.jrpc(A,i++,c,[q,r],function(C){e.resume();!C.error&&C.result?t(C.result):t(null)},function(C,s){e.resume();e.error("[AJAX] Response: "+
s+"\n"+C.responseText)})}}(typeof n.login=="boolean"?"login":n.login);if(j("prompt",n.prompt)){var v=new Y({name:n.name,eval:b,prompt:n.prompt,greetings:n.greetings}),k=e.find(".terminal-output").next().cmd({prompt:n.prompt,history:n.history,width:"100%",keydown:n.keydown?function(c){return n.keydown(c,e)}:null,keypress:M,commands:F});e.livequery(function(){e.resize()});G.append(e);n.enabled?e.focus():e.disable();g(window).resize(e.resize);if(typeof n.onInit=="function")n.onInit(e);e.click(function(){e.focus()});
if(e.token&&!e.token()&&e.login_name&&!e.login_name())L();else{H();e.echo(a.greetings||e.signature)}typeof g.fn.init.prototype.mousewheel==="function"&&e.mousewheel(function(c,i){i>0?e.scroll(-40):e.scroll(40);return false},true)}e.data("terminal",e);return e}})(jQuery);
