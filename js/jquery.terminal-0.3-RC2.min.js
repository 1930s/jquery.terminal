/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                           version 0.3-RC2
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 LiveQuery plugin Dual MIT and GPL
 Copyright (c) 2008 Brandon Aaron (http://brandonaaron.net)

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

*/
Array.prototype.has=function(g){for(var w=this.length;w--;)if(this[w]==g)return true;return false};
(function(g,w){function Q(a,d){var b;if(typeof a==="string"&&typeof d==="string"){localStorage[a]=d;return true}else if(typeof a==="object"&&typeof d==="undefined"){for(b in a)if(a.hasOwnProperty(b))localStorage[b]=a[b];return true}return false}function N(a,d){var b,h;b=new Date;b.setTime(b.getTime()+31536E6);b="; expires="+b.toGMTString();if(typeof a==="string"&&typeof d==="string"){document.cookie=a+"="+d+b+"; path=/";return true}else if(typeof a==="object"&&typeof d==="undefined"){for(h in a)if(a.hasOwnProperty(h))document.cookie=
h+"="+a[h]+b+"; path=/";return true}return false}function R(a){return localStorage[a]}function S(a){var d,b,h;a+="=";d=document.cookie.split(";");for(b=0;b<d.length;b++){for(h=d[b];h.charAt(0)===" ";)h=h.substring(1,h.length);if(h.indexOf(a)===0)return h.substring(a.length,h.length)}return null}function T(a){return delete localStorage[a]}function U(a){return N(a,"",-1)}function O(a,d){var b=[],h=a.length;if(h<d)return[a];for(var j=0;j<h;j+=d)b.push(a.substring(j,j+d));return b}function x(a){if(typeof a==
"string"){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;");a=a.replace(/\n/g,"<br/>");a=a.replace(/ /g,"&nbsp;");return a=a.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;")}else return""}function P(a){var d=a instanceof Array?a:a?[a]:[],b=0;g.extend(this,{left:function(){if(b===0)b=d.length-1;else--b;return d[b]},right:function(){if(b==d.length-1)b=0;else++b;return d[b]},current:function(){return d[b]},data:function(){return d},reset:function(){b=0},append:function(h){d.push(h);this.reset()}})}
function V(a){var d=a?[a]:[];g.extend(this,{size:function(){return d.length},pop:function(){if(d.length===0)return null;else{var b=d[d.length-1];d=d.slice(0,d.length-1);return b}},push:function(b){d=d.concat([b]);return b},top:function(){return d.length>0?d[d.length-1]:null}})}function W(a){var d=true;if(typeof a==="string"&&a!=="")a+="_";var b=g.Storage.get(a+"commands"),h=new P(b?eval("("+b+")"):[""]);g.extend(this,{append:function(j){if(d&&h.current()!=j){h.append(j);g.Storage.set(a+"commands",
g.json_stringify(h.data()))}},data:function(){return h.data()},next:function(){return h.right()},last:function(){h.reset()},previous:function(){return h.left()},clear:function(){h=new P;g.Storage.remove(a+"commands")},enable:function(){d=true},disable:function(){d=false}})}g.extend(g.fn,{livequery:function(a,d,b){var h=this,j;if(g.isFunction(a)){b=d;d=a;a=w}g.each(g.livequery.queries,function(p,v){if(h.selector==v.selector&&h.context==v.context&&a==v.type&&(!d||d.$lqguid==v.fn.$lqguid)&&(!b||b.$lqguid==
v.fn2.$lqguid))return(j=v)&&false});j=j||new g.livequery(this.selector,this.context,a,d,b);j.stopped=false;j.run();return this},expire:function(a,d,b){var h=this;if(g.isFunction(a)){b=d;d=a;a=w}g.each(g.livequery.queries,function(j,p){if(h.selector==p.selector&&h.context==p.context&&(!a||a==p.type)&&(!d||d.$lqguid==p.fn.$lqguid)&&(!b||b.$lqguid==p.fn2.$lqguid)&&!this.stopped)g.livequery.stop(p.id)});return this}});g.livequery=function(a,d,b,h,j){this.selector=a;this.context=d||document;this.type=
b;this.fn=h;this.fn2=j;this.elements=[];this.stopped=false;this.id=g.livequery.queries.push(this)-1;h.$lqguid=h.$lqguid||g.livequery.guid++;if(j)j.$lqguid=j.$lqguid||g.livequery.guid++;return this};g.livequery.prototype={stop:function(){var a=this;if(this.type)this.elements.unbind(this.type,this.fn);else this.fn2&&this.elements.each(function(d,b){a.fn2.apply(b)});this.elements=[];this.stopped=true},run:function(){if(!this.stopped){var a=this,d=this.elements,b=g(this.selector,this.context),h=b.not(d);
this.elements=b;if(this.type){h.bind(this.type,this.fn);d.length>0&&g.each(d,function(j,p){g.inArray(p,b)<0&&g.event.remove(p,a.type,a.fn)})}else{h.each(function(){a.fn.apply(this)});this.fn2&&d.length>0&&g.each(d,function(j,p){g.inArray(p,b)<0&&a.fn2.apply(p)})}}}};g.extend(g.livequery,{guid:0,queries:[],queue:[],running:false,timeout:null,checkQueue:function(){if(g.livequery.running&&g.livequery.queue.length)for(var a=g.livequery.queue.length;a--;)g.livequery.queries[g.livequery.queue.shift()].run()},
pause:function(){g.livequery.running=false},play:function(){g.livequery.running=true;g.livequery.run()},registerPlugin:function(){g.each(arguments,function(a,d){if(g.fn[d]){var b=g.fn[d];g.fn[d]=function(){var h=b.apply(this,arguments);g.livequery.run();return h}}})},run:function(a){if(a!=w)g.inArray(a,g.livequery.queue)<0&&g.livequery.queue.push(a);else g.each(g.livequery.queries,function(d){g.inArray(d,g.livequery.queue)<0&&g.livequery.queue.push(d)});g.livequery.timeout&&clearTimeout(g.livequery.timeout);
g.livequery.timeout=setTimeout(g.livequery.checkQueue,20)},stop:function(a){a!=w?g.livequery.queries[a].stop():g.each(g.livequery.queries,function(d){g.livequery.queries[d].stop()})}});g.livequery.registerPlugin("append","prepend","after","before","wrap","attr","removeAttr","addClass","removeClass","toggleClass","empty","remove");g(function(){g.livequery.play()});var X=g.prototype.init;g.prototype.init=function(a,d){var b=X.apply(this,arguments);if(a&&a.selector){b.context=a.context;b.selector=a.selector}if(typeof a==
"string"){b.context=d||document;b.selector=a}return b};g.prototype.init.prototype=g.prototype;var K=typeof window.localStorage!=="undefined";g.extend({Storage:{set:K?Q:N,get:K?R:S,remove:K?T:U}});jQuery.fn.extend({everyTime:function(a,d,b,h,j){return this.each(function(){jQuery.timer.add(this,a,d,b,h,j)})},oneTime:function(a,d,b){return this.each(function(){jQuery.timer.add(this,a,d,b,1)})},stopTime:function(a,d){return this.each(function(){jQuery.timer.remove(this,a,d)})}});jQuery.extend({timer:{guid:1,
global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},timeParse:function(a){if(a==w||a==null)return null;var d=this.regex.exec(jQuery.trim(a.toString()));return d[2]?parseInt(d[1],10)*(this.powers[d[2]]||1):a},add:function(a,d,b,h,j,p){var v=0;if(jQuery.isFunction(b)){j||(j=h);h=b;b=d}d=jQuery.timer.timeParse(d);if(!(typeof d!="number"||isNaN(d)||d<=0)){if(j&&j.constructor!=Number){p=!!j;j=0}j=j||0;p=p||false;if(!a.$timers)a.$timers={};a.$timers[b]||(a.$timers[b]=
{});h.$timerID=h.$timerID||this.guid++;var m=function(){if(!(p&&this.inProgress)){this.inProgress=true;if(++v>j&&j!==0||h.call(a,v)===false)jQuery.timer.remove(a,b,h);this.inProgress=false}};m.$timerID=h.$timerID;a.$timers[b][h.$timerID]||(a.$timers[b][h.$timerID]=window.setInterval(m,d));this.global[b]||(this.global[b]=[]);this.global[b].push(a)}},remove:function(a,d,b){var h=a.$timers,j;if(h){if(d){if(h[d]){if(b){if(b.$timerID){window.clearInterval(h[d][b.$timerID]);delete h[d][b.$timerID]}}else for(b in h[d]){window.clearInterval(h[d][b]);
delete h[d][b]}for(j in h[d])break;if(!j){j=null;delete h[d]}}}else for(d in h)this.remove(a,d,b);for(j in h)break;if(!j)a.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",function(){var a=jQuery.timer.global,d;for(d in a)for(var b=a[d],h=b.length;--h;)jQuery.timer.remove(b[h],d)});g.json_stringify=function(a,d){var b="";d=d===w?1:d;switch(typeof a){case "function":b+=a;break;case "boolean":b+=a?"true":"false";break;case "object":if(a===null)b+="null";else if(a instanceof Array){b+=
"[";for(var h=a.length,j=0;j<h-1;++j)b+=g.json_stringify(a[j],d+1);b+=g.json_stringify(a[h-1],d+1)+"]"}else{b+="{";for(h in a)if(a.hasOwnProperty(h))b+='"'+h+'":'+g.json_stringify(a[h],d+1);b+="}"}break;case "string":h=a;var p={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};for(j in p)if(p.hasOwnProperty(j))h=h.replace(RegExp(j,"g"),p[j]);b+='"'+h+'"';break;case "number":b+=String(a)}b+=d>1?",":"";if(d==1)b=b.replace(/,([\]}])/g,"$1");return b.replace(/([\[{]),/g,"$1")};g.fn.cmd=
function(a){function d(){var e=g("<span>").html("&nbsp").appendTo(b);j=Math.floor(b.width()/e.width());e.remove()}var b=this;b.addClass("cmd");b.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');var h=g("<textarea/>").addClass("clipboard").appendTo(b);a.width&&b.width(a.width);var j,p,v=a.mask||false,m="",n=0,A,G=a.enabled,L,z,I=function(){var e=b.find(".cursor");return function(){e.toggleClass("inverted")}}(),C=function(e){function q(o,k){if(k==o.length){y.html(x(o));
l.html("&nbsp;");B.html("")}else if(k===0){y.html("");l.html(x(o.slice(0,1)));B.html(x(o.slice(1)))}else{var c=x(o.slice(0,k));y.html(c);c=o.slice(k,k+1);l.html(c==" "?"&nbsp;":x(c));k==o.lenght-1?B.html(""):B.html(x(o.slice(k+1)))}}function M(o){var k=B;g.each(o,function(c,i){k=g("<div>"+x(i)+"</div>").insertAfter(k)})}function E(o){g.each(o,function(k,c){y.before("<div>"+x(c)+"</div>")})}var l=e.find(".cursor"),y=l.prev(),B=l.next();return function(){var o=v?m.replace(/./g,"*"):m;e.find("div").remove();
y.html("");if(o.length>j-p-1){var k;k=o.substring(0,j-p-1);var c=o.substring(j-p-1);k=[k].concat(O(c,j));c=k[0].length;if(n<c){q(k[0],n);M(k.slice(1))}else{var i=k.length;if(n<=c){q(k[0],n);M(k.slice(1))}else{var r=k.slice(-1)[0];o=o.length-n;if(o<r.length){E(k.slice(0,-1));q(r,r.length-o-1)}else if(i==3){console.log("         if");y.before("<div>"+x(k[0])+"</div>");q(k[1],n-c-1);B.after("<div>"+x(k[2])+"</div>")}else{o=Math.floor((n+p)/j);i=k[o];c=(n-c-1)%j;x(i.slice(0,c));q(i,c);E(k.slice(0,o));
M(k.slice(o+1))}}}}else if(o===""){y.html("");l.html("&nbsp;");B.html("")}else q(o,n)}}(b),f=function(){var e=b.find(".prompt");return function(){if(typeof A=="string"){p=A.length;e.html(x(A)+"&nbsp;")}else A(function(q){p=q.length;e.html(x(q)+"&nbsp;")});d()}}();g.extend(b,{name:function(e){if(e!==w){L=e;z=new W(e)}else return L},history:function(){return z},set:function(e,q){if(e!==w){m=e;if(!q)n=m.length;C()}},insert:function(e,q){if(n==m.length)m+=e;else m=n===0?e+m:m.slice(0,n)+e+m.slice(n);
q||(n+=e.length);C()},get:function(){return m},commands:function(e){if(e)a.commands=e;else return e},destroy:function(){g(document.documentElement).unbind(".commandline");b.find(".prompt").remove()},prompt:function(e){if(e===w)return A;else{if(typeof e=="string"||typeof e=="function")A=e;else throw"prompt must be a function or string";f()}},position:function(e){if(typeof e=="number"){n=e;C()}else return n},resize:function(){d();C()},enable:function(){if(!this.isenabled()){b.everyTime(500,"blink",
I);G=true}},isenabled:function(){return G},disable:function(){if(this.isenabled()){b.stopTime("blink",I);b.find(".cursor").removeClass("inverted");G=false}},mask:function(e){if(typeof e=="boolean"){v=e;C()}else return v}});b.name(a.name||"");A=a.prompt||">";f();a.enabled===w&&!a.enabled&&b.enable();g(document.documentElement).keypress(function(e){if(G){var q;if(a.keypress)q=a.keypress(e);if(q===w||q)if([38,32,13,40,0,8].has(e.which)&&e.keyCode!=123&&!(e.which==40&&e.shiftKey||e.which==38&&e.shiftKey))return false;
else if(!e.ctrlKey&&!(e.altKey&&e.which==100)){b.insert(String.fromCharCode(e.which));if(e.which==45||e.shiftKey&&e.which==43)return false}}}).keydown(function(e){if(a.keydown&&a.keydown(e)===false)return false;if(G){var q;if(e.keyCode==13){z&&m&&z.append(m);z.last();e=m;b.set("");typeof A=="function"&&f();a.commands&&a.commands(e)}else if(e.which==32)b.insert(" ");else if(e.which==8){if(m!==""&&n>0){m=m.slice(0,n-1)+m.slice(n,m.length);--n;C()}}else if(e.which==9)b.insert("\t");else if(e.which==
46||e.which==68&&e.ctrlKey){if(m!==""&&n<m.length){m=m.slice(0,n)+m.slice(n+1,m.length);C()}return true}else if(z&&e.which==38||e.which==80&&e.ctrlKey)b.set(z.previous());else if(z&&e.which==40||e.which==78&&e.ctrlKey)b.set(z.next());else if(e.which==27)b.set("");else if(e.which==37||e.which==66&&e.ctrlKey)if(e.ctrlKey&&e.which!=66){q=n-1;e=0;for(m[q]==" "&&--q;q>0;--q)if(m[q]==" "&&m[q+1]!=" "){e=q+1;break}b.position(e)}else{if(n>0){--n;C()}}else if(e.which==39||e.which==70&&e.ctrlKey)if(e.ctrlKey&&
e.which!=70){m[n]==" "&&++n;e=m.slice(n).match(/[^ ] {2,}| +[^ ]?/);if(!e||e[0].match(/^ +$/))n=m.length;else if(e[0][0]!=" ")n+=e.index+1;else{n+=e.index+e[0].length-1;e[0][e[0].length-1]!=" "&&--n}C()}else{if(n<m.length){++n;C()}}else if(e.which==123)return true;else if(e.which==36)b.position(0);else if(e.which==35)b.position(m.length);else if(e.metaKey)if(e.shiftKey){if(e.which==84)return true}else{if(!e.altKey)if(e.which==65)b.position(0);else if(e.which==69)b.position(m.length);else if(e.which==
88||e.which==67||e.which==87||e.which==84)return true;else if(e.which==86){h.focus();window.setTimeout(function(){b.insert(h.val());h.blur();h.val("")},1);return true}else if(e.which==75)if(n===0)b.set("");else n!=m.length&&b.set(m.slice(0,n));else if(e.which==17)return true}else if(e.altKey)e.which==68&&b.set(m.slice(0,n)+m.slice(n).replace(/[^ ]+ |[^ ]+$/,""),true);else return true;return false}else if(e.altKey&&e.which==68||e.ctrlKey&&[65,66,68,69,80,78,70].has(e.which)||[35,36,37,38,39,40].has(e.which))return false});
return b};g.jrpc=function(a,d,b,h,j,p){d=g.json_stringify({jsonrpc:"2.0",method:b,params:h,id:d});return g.ajax({url:a,data:d,success:j,error:p,contentType:"application/json",dataType:"json",beforeSend:function(v){v.setRequestHeader("Foo","bar")},async:true,cache:false,type:"POST"})};K=/ {15}$/;var Y=[["jQuery Terminal","(c) 2011 jcubic"],["JQuery Terminal Emulator v. 0.3-RC2","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,"")],["JQuery Terminal Emulator version version 0.3-RC2",
"Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      _______                 ________                        __","     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /","/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\___/____/_/_\\_ / /_/____/_//_/ /_/_/_/  \\/\\__\\_\\___/","         \\/          /____/                                    ".replace(K,"")+"version 0.3-RC2",
"Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      __ _____                     ________                              __","     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /","/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                           ".replace(K,
"")+"version 0.3-RC2","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],H=new function(a){var d=a?[a]:[],b=0;g.extend(this,{rotate:function(){if(d.length==1)return d[0];else{if(b==d.length-1)b=0;else++b;return d[b]}},length:function(){return d.length},set:function(h){for(var j=d.length;j--;)if(d[j]===h){b=j;return}this.append(h)},front:function(){return d[b]},append:function(h){d.push(h)}})},Z=[];g.fn.terminal=function(a,d){function b(){if(d.greetings===w)f.signature();else typeof d.greetings==
"string"&&m(d.greetings)}function h(){var c=g("<span>x</span>").appendTo(f),i=Math.floor(f.width()/c.width());c.remove();return i}function j(c,i){if(typeof c=="string")f.echo("["+i+"]: "+c).addClass("error");else{f.echo("["+i+"]: "+c.fileName+": "+c.message).addClass("error");f.pause();g.get(c.fileName,function(r){f.resume();var s=c.lineNumber-1;f.echo("["+c.lineNumber+"]"+r.split("\n")[s]).addClass("error")})}}function p(c,i){try{if(typeof i=="function")i(function(){});else if(typeof i!="string")throw c+
" must be string or function";}catch(r){j(r,c.toUpperCase());return false}return true}function v(c){c.scrollTop(f.attr("scrollHeight"))}function m(c){c=typeof c=="string"?c:String(c);var i;if(c.length>E){c=c.split("\n");i=g("<div></div>");for(var r=c.length,s=0;s<r;++s)if(c[s]===""||c[s]=="\r")i.append("<div>&nbsp;</div>");else if(c[s].length>E){var u=O(c[s],E);g.each(u,function(D,t){g("<div>").html(x(t)).appendTo(i)})}else g("<div>").html(x(c[s])).appendTo(i)}else i=g("<div/>").html(x(c));q.append(i);
i.width("100%");v(f);return i}function n(c,i){var r=1,s=function(u,D){i.pause();g.jrpc(c,r++,u,D,function(t){if(t.error)i.error("[RPC] "+t.error.message);else if(typeof t.result=="string")i.echo(t.result);else if(t.result instanceof Array)i.echo(t.result.join(" "));else if(typeof t.result=="object"){var F="",J;for(J in t.result)if(t.result.hasOwnProperty(J))F+=J+": "+t.result[J]+"\n";i.echo(F)}i.resume()},function(t,F){i.error("[AJAX] "+F+" - Server reponse is: \n"+t.responseText);i.resume()})};return function(u,
D){if(u!==""){var t,F;if(u.match(/[^ ]* /)){u=u.split(/ */);t=u[0];F=u.slice(1)}else{t=u;F=[]}if(!l.login||t=="help")s(t,F);else{var J=D.token();J?s(t,[J].concat(F)):D.error("[AUTH] Access denied (no token)")}}}}function A(c){var i=k.prompt();if(k.mask())c=c.replace(/./g,"*");typeof i=="function"?i(function(r){f.echo(r+" "+c)}):f.echo(i+" "+c)}function G(c){try{var i=o.top();if(c=="exit"&&l.exit)if(o.size()==1)l.login?z():f.echo("You can exit from main interpeter");else f.pop("exit");else{A(c);c==
"clear"&&l.clear?f.clear():i.eval(c,f)}}catch(r){j(r,"USER");throw r;}}function L(){var c=null;k.prompt("login:");l.history&&k.history().disable();k.commands(function(i){try{A(i);if(c){k.mask(false);f.pause();l.login(c,i,function(s){if(s){var u=l.name;u=u?"_"+u:"";g.Storage.set("token"+u,s);g.Storage.set("login"+u,c);k.commands(G);I(true);b()}else{f.error("Wrong password try again");k.prompt("login:");c=null}f.resume();l.history&&k.history().enable()})}else{c=i;k.prompt("password:");k.mask(true)}}catch(r){j(r,
"LOGIN",f);throw r;}})}function z(){var c=l.name;c=c?"_"+c:"";g.Storage.remove("token"+c,null);g.Storage.remove("login"+c,null);l.history&&k.history().disable();L()}function I(){var c=o.top(),i="";if(c.name!==w&&c.name!=="")i+=c.name+"_";i+=M;k.name(i);k.prompt(c.prompt);l.history&&k.history().enable();k.set("");if(typeof c.onStart=="function")c.onStart(f)}function C(c){if(f.paused()){if(c.which==100&&c.ctrlKey){for(c=request.length;c--;){var i=request[c];if(4!=i.readyState)try{i.abort()}catch(r){f.error("error in aborting ajax")}}f.resume();
return false}}else{if(l.keypress&&l.keypress(c)===false)return false;if(c.which==100&&c.ctrlKey&&l.exit&&k.get()===""){l.name==o.top().name&&!l.login?f.echo("you can't exit from top interpreter"):f.pop("");return false}else if(c.charCode==118&&c.ctrlKey){window.setTimeout(function(){f.attr({scrollTop:f.attr("scrollHeight")})},1);return true}else if(c.which==34)f.scroll(f.height());else c.which==33?f.scroll(-f.height()):f.attr({scrollTop:f.attr("scrollHeight")})}}var f=this,e=[],q,M=H.length(),E,l=
{name:null,prompt:">",history:true,exit:true,clear:true,enabled:true,login:null};if(d){d.width&&f.width(d.width);d.height&&f.height(d.height);g.extend(l,d)}var y=!l.enabled;if(f.length===0)throw'Sorry, but terminal said that "'+f.selector+'" is not valid selector';if(f.data("terminal")){f.ajaxSend(function(c,i){Z.push(i)});return f.data("terminal")}q=g("<div>").addClass("terminal-output").appendTo(f);f.addClass("terminal").append("<div/>");g.extend(f,{clear:function(){q.html("");k.set("");e=[];f.attr({scrollTop:0});
d.greetings=null;return f},paused:function(){return y},pause:function(){if(k){f.disable();k.hide()}return f},resume:function(){if(k){f.enable();k.show();v(f)}return f},cols:function(){return E},rows:function(){return e.length},history:function(){return k.history().data()},next:function(){if(H.length()==1)return f;else{H.front().disable();return H.rotate().enable()}},focus:function(c){f.oneTime(1,function(){if(H.length()==1)c===false?f.disable():f.enable();else if(c===false)f.next();else{H.front().disable();
H.set(f);f.enable()}});return f},enable:function(){E===w&&f.resize();if(y)if(k){k.enable();y=false}return f},disable:function(){if(!y)if(k){y=true;k.disable()}return f},enabled:function(){return y},signature:function(){var c=f.cols();c=c<15?null:c<35?0:c<55?1:c<64?2:c<75?3:4;c!==null&&g.each(Y[c],function(i,r){m(r)})},get_command:function(){return k.get()},insert:function(c){k.insert(c);return f},set_prompt:function(c){p("prompt",c)&&k.prompt(c);return f},set_command:function(c){k.set(c);return f},
set_mask:function(c){k.mask(c);return f},get_output:function(){return e.join("\n")},resize:function(c,i){if(c&&i){f.width(c);f.height(i)}E=h();k.resize();q.html("");b();for(var r=e.length,s=0;s<r;++s)m(e[s]);v(f);return f},echo:function(c){e.push(c);return m(c)},error:function(c){return f.echo(c).addClass("error")},scroll:function(c){c>f.attr("scrollTop")&&c>0&&f.attr("scrollTop",0);var i=f.attr("scrollTop");f.attr("scrollTop",i+c);return f},logout:l.login?function(){for(;o.size()>1;)o.pop();z();
return f}:function(){throw"You don't have login function";},token:l.login?function(){var c=l.name;return g.Storage.get("token"+(c?"_"+c:""))}:null,login_name:l.login?function(){var c=l.name;return g.Storage.get("login_"+(c?"_"+c:""))}:null,name:function(){return l.name},push:function(c,i){if(!i.prompt||p("prompt",i.prompt)){if(typeof c=="string")c=n(i.eval,f);o.push({name:i.name,eval:c,prompt:i.prompt,login:i.login,onStart:i.onStart,onExit:i.onExit});I(true)}return f},pop:function(c){c!==w&&A(c);
if(o.top().name===l.name){if(l.login){z();if(typeof l.onAfterLogout=="function")l.onAfterLogout(f)}}else{c=o.pop();I();if(typeof c.onExit=="function")c.onExit(f)}return f}});var B;switch(typeof a){case "string":B=a;a=n(a,f);break;case "object":a=function(c){return function(i){if(i!=""){i=i.split(/ */);var r=i[0];i=i.slice(1);var s=c[r];typeof s=="function"?s.apply(f,i):f.echo("Command '"+r+"' Not Found")}}}(a)}if(B&&typeof l.login=="string"||B)l.login=function(c){var i=1;return function(r,s,u){f.pause();
g.jrpc(B,i++,c,[r,s],function(D){f.resume();!D.error&&D.result?u(D.result):u(null)},function(D,t){f.resume();f.error("[AJAX] Response: "+t+"\n"+D.responseText)})}}(typeof l.login=="boolean"?"login":l.login);if(p("prompt",l.prompt)){var o=new V({name:l.name,eval:a,prompt:l.prompt,greetings:l.greetings}),k=f.find(".terminal-output").next().cmd({prompt:l.prompt,history:l.history,width:"100%",keydown:l.keydown?function(c){return l.keydown(c,f)}:null,keypress:C,commands:G});f.livequery(function(){f.oneTime(10,
function(){f.resize()})});E=h();H.append(f);l.enabled?f.focus():f.disable();g(window).resize(f.resize);if(typeof l.onInit=="function")l.onInit(f);f.click(function(){f.focus()});if(f.token&&!f.token()&&f.login_name&&!f.login_name())L();else{I(true);b()}typeof g.fn.init.prototype.mousewheel==="function"&&f.mousewheel(function(c,i){i>0?f.scroll(-40):f.scroll(40);return false},true)}f.data("terminal",f);return f}})(jQuery);
