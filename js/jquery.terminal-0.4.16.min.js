/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                              version 0.4.16
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 LiveQuery plugin Dual MIT and GPL
 Copyright (c) 2008 Brandon Aaron (http://brandonaaron.net)

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

 Date: Mon, 11 Jun 2012 20:27:43 +0000
*/
Array.prototype.has=function(l){for(var B=this.length;B--;)if(this[B]==l)return true;return false};function get_stack(l){return l?[l.toString().match(/.*\n.*\n/)].concat(get_stack(l.caller)):[]}
(function(l,B){function ga(d,e){var f;if(typeof d==="string"&&typeof e==="string"){localStorage[d]=e;return true}else if(typeof d==="object"&&typeof e==="undefined"){for(f in d)if(d.hasOwnProperty(f))localStorage[f]=d[f];return true}return false}function ba(d,e){var f,i;f=new Date;f.setTime(f.getTime()+31536E6);f="; expires="+f.toGMTString();if(typeof d==="string"&&typeof e==="string"){document.cookie=d+"="+e+f+"; path=/";return true}else if(typeof d==="object"&&typeof e==="undefined"){for(i in d)if(d.hasOwnProperty(i))document.cookie=
i+"="+d[i]+f+"; path=/";return true}return false}function ha(d){return localStorage[d]}function ia(d){var e,f,i;d+="=";e=document.cookie.split(";");for(f=0;f<e.length;f++){for(i=e[f];i.charAt(0)===" ";)i=i.substring(1,i.length);if(i.indexOf(d)===0)return i.substring(d.length,i.length)}return null}function ja(d){return delete localStorage[d]}function ka(d){return ba(d,"",-1)}function X(d,e){var f=[],i=d.length;if(i<e)return[d];for(var m=0;m<i;m+=e)f.push(d.substring(m,m+e));return f}function E(d){if(typeof d==
"string"){d=d.replace(/&(?!#[0-9]+;|[a-zA-Z]+;)/g,"&amp;");d=d.replace(/</g,"&lt;").replace(/>/g,"&gt;");d=d.replace(/\n/g,"<br/>");d=d.replace(/ /g,"&nbsp;");d=d.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");var e=d.split(la);if(e.length>1)d=l.map(e,function(f){return f===""?f:f[0]=="["?f.replace(Y,function(i,m,y,C,p){if(p==="")return"<span>&nbsp;</span>";i="";if(m.indexOf("b")!=-1)i+="font-weight:bold;";var J="text-decoration:";if(m.indexOf("u")!=-1)J+="underline ";if(m.indexOf("s")!=-1)J+="line-through";
if(m.indexOf("s")!=-1||m.indexOf("u")!=-1)i+=J+";";if(m.indexOf("i")!=-1)i+="font-style:italic; ";if(y.match(ca))i+="color:"+y+";";if(C.match(ca))i+="background-color:"+C;return d='<span style="'+i+'">'+p+"</span>"}):"<span>"+f+"</span>"}).join("");return d}else return""}function da(d){var e=d instanceof Array?d:d?[d]:[],f=0;l.extend(this,{left:function(){if(f===0)f=e.length-1;else--f;return e[f]},right:function(){if(f==e.length-1)f=0;else++f;return e[f]},current:function(){return e[f]},data:function(){return e},
length:function(){return e.length},reset:function(){f=0},append:function(i){e.push(i);this.reset()}})}function ma(d){var e=d?[d]:[];l.extend(this,{size:function(){return e.length},pop:function(){if(e.length===0)return null;else{var f=e[e.length-1];e=e.slice(0,e.length-1);return f}},push:function(f){e=e.concat([f]);return f},top:function(){return e.length>0?e[e.length-1]:null}})}function na(d){var e=true;if(typeof d==="string"&&d!=="")d+="_";var f=l.Storage.get(d+"commands"),i=new da(f?eval("("+f+
")"):[""]);l.extend(this,{append:function(m){if(e&&i.current()!=m){i.append(m);l.Storage.set(d+"commands",l.json_stringify(i.data()))}},data:function(){return i.data()},next:function(){return i.right()},last:function(){i.reset()},previous:function(){return i.left()},clear:function(){i=new da;l.Storage.remove(d+"commands")},enable:function(){e=true},disable:function(){e=false}})}var T=typeof window.localStorage!=="undefined";l.extend({Storage:{set:T?ga:ba,get:T?ha:ia,remove:T?ja:ka}});jQuery.fn.extend({everyTime:function(d,
e,f,i,m){return this.each(function(){jQuery.timer.add(this,d,e,f,i,m)})},oneTime:function(d,e,f){return this.each(function(){jQuery.timer.add(this,d,e,f,1)})},stopTime:function(d,e){return this.each(function(){jQuery.timer.remove(this,d,e)})}});jQuery.extend({timer:{guid:1,global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},timeParse:function(d){if(d==B||d===null)return null;var e=this.regex.exec(jQuery.trim(d.toString()));return e[2]?parseInt(e[1],10)*(this.powers[e[2]]||
1):d},add:function(d,e,f,i,m,y){var C=0;if(jQuery.isFunction(f)){m||(m=i);i=f;f=e}e=jQuery.timer.timeParse(e);if(!(typeof e!="number"||isNaN(e)||e<=0)){if(m&&m.constructor!=Number){y=!!m;m=0}m=m||0;y=y||false;if(!d.$timers)d.$timers={};d.$timers[f]||(d.$timers[f]={});i.$timerID=i.$timerID||this.guid++;var p=function(){if(!(y&&this.inProgress)){this.inProgress=true;if(++C>m&&m!==0||i.call(d,C)===false)jQuery.timer.remove(d,f,i);this.inProgress=false}};p.$timerID=i.$timerID;d.$timers[f][i.$timerID]||
(d.$timers[f][i.$timerID]=window.setInterval(p,e));this.global[f]||(this.global[f]=[]);this.global[f].push(d)}},remove:function(d,e,f){var i=d.$timers,m;if(i){if(e){if(i[e]){if(f){if(f.$timerID){window.clearInterval(i[e][f.$timerID]);delete i[e][f.$timerID]}}else for(f in i[e]){window.clearInterval(i[e][f]);delete i[e][f]}for(m in i[e])break;if(!m){m=null;delete i[e]}}}else for(e in i)this.remove(d,e,f);for(m in i)break;if(!m)d.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",
function(){var d=jQuery.timer.global,e;for(e in d)for(var f=d[e],i=f.length;--i;)jQuery.timer.remove(f[i],e)});var la=/(\[\[[bius]*;[^;]*;[^\]]*\][^\]\[]*\])/g,Y=/\[\[([bius]*);([^;]*);([^\]]*)\]([^\]\[]*)\]/g,ca=/#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})/;l.json_stringify=function(d,e){var f="",i;e=e===B?1:e;switch(typeof d){case "function":f+=d;break;case "boolean":f+=d?"true":"false";break;case "object":if(d===null)f+="null";else if(d instanceof Array){f+="[";var m=d.length;for(i=0;i<m-1;++i)f+=l.json_stringify(d[i],
e+1);f+=l.json_stringify(d[m-1],e+1)+"]"}else{f+="{";for(m in d)if(d.hasOwnProperty(m))f+='"'+m+'":'+l.json_stringify(d[m],e+1);f+="}"}break;case "string":m=d;var y={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};for(i in y)if(y.hasOwnProperty(i))m=m.replace(RegExp(i,"g"),y[i]);f+='"'+m+'"';break;case "number":f+=String(d)}f+=e>1?",":"";if(e==1)f=f.replace(/,([\]}])/g,"$1");return f.replace(/([\[{]),/g,"$1")};l.fn.cmd=function(d){function e(){k.toggleClass("inverted")}function f(){z=
"(reverse-i-search)`"+F+"': ";H()}function i(c){var q=D.data(),P=RegExp("^"+F),w=q.length;if(c&&Q>0)w-=Q;for(c=w;c--;)if(P.test(q[c])){Q=q.length-c;o=0;p.set(q[c],true);x();break}}function m(c){var q=c.substring(0,A-L);c=c.substring(A-L);return[q].concat(X(c,A))}function y(){J.focus();p.oneTime(1,function(){p.insert(J.val());J.blur().val("")})}function C(c){if(d.keydown&&d.keydown(c)===false)return false;if(M){var q;if(G&&(c.which==35||c.which==36||c.which==37||c.which==38||c.which==39||c.which==
40||c.which==66||c.which==13||c.which==27)){z=U;G=false;Q=null;F="";H();if(c.which==27)a="";x();C.call(this,c)}else if(c.altKey){if(c.which==68){p.set(a.slice(0,o)+a.slice(o).replace(/[^ ]+ |[^ ]+$/,""),true);return false}return true}else if(c.keyCode==13){if(D&&a&&(d.historyFilter&&d.historyFilter(a)||!d.historyFilter))D.data().slice(-1)[0]!=a&&D.append(a);D.last();c=a;p.set("");d.commands&&d.commands(c);typeof z=="function"&&H()}else if(c.which==32)if(G){F+=" ";f()}else p.insert(" ");else if(c.which==
8)if(G){F=F.slice(0,-1);f()}else{if(a!==""&&o>0){a=a.slice(0,o-1)+a.slice(o,a.length);--o;x()}}else if(c.which==9&&!(c.ctrlKey||c.altKey))p.insert("\t");else if(c.which==46){if(a!==""&&o<a.length){a=a.slice(0,o)+a.slice(o+1,a.length);x()}return true}else if(D&&c.which==38||c.which==80&&c.ctrlKey)p.set(D.previous());else if(D&&c.which==40||c.which==78&&c.ctrlKey)p.set(D.next());else if(c.which==37||c.which==66&&c.ctrlKey)if(c.ctrlKey&&c.which!=66){q=o-1;c=0;for(a[q]==" "&&--q;q>0;--q)if(a[q]==" "&&
a[q+1]!=" "){c=q+1;break}else if(a[q]=="\n"&&a[q+1]!="\n"){c=q;break}p.position(c)}else{if(o>0){--o;x()}}else if(c.which==82&&c.ctrlKey)if(G){console.log("deep search");i(true)}else{U=z;f();a="";x();G=true}else if(c.which==39||c.which==70&&c.ctrlKey)if(c.ctrlKey&&c.which!=70){a[o]==" "&&++o;c=a.slice(o).match(/\S[\n\s]{2,}|[\n\s]+\S?/);if(!c||c[0].match(/^\s+$/))o=a.length;else if(c[0][0]!=" ")o+=c.index+1;else{o+=c.index+c[0].length-1;c[0][c[0].length-1]!=" "&&--o}x()}else{if(o<a.length){++o;x()}}else if(c.which==
123)return true;else if(c.which==36)p.position(0);else if(c.which==35)p.position(a.length);else if(c.ctrlKey||c.metaKey)if(c.shiftKey){if(c.which==84)return true}else if(c.which==65)p.position(0);else if(c.which==69)p.position(a.length);else if(c.which==88||c.which==67||c.which==87||c.which==84)return true;else if(c.which==86){y();return true}else if(c.which==75)if(o===0)p.set("");else o!=a.length&&p.set(a.slice(0,o));else if(c.which==85){p.set(a.slice(o,a.length));p.position(0)}else{if(c.which==
17)return true}else return true;return false}}var p=this;p.addClass("cmd");p.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');var J=l("<textarea/>").addClass("clipboard").appendTo(p);d.width&&p.width(d.width);var A,L,G=false,F="",Q=null,U,V=d.mask||false,a="",o=0,z,M=d.enabled,K,D,k=p.find(".cursor"),x=function(c){function q(g,n){if(n==g.length){b.html(E(g));k.html("&nbsp;");h.html("")}else if(n===0){b.html("");k.html(E(g.slice(0,1)));h.html(E(g.slice(1)))}else{var j=
E(g.slice(0,n));b.html(j);j=g.slice(n,n+1);k.html(j==" "?"&nbsp;":E(j));n==g.length-1?h.html(""):h.html(E(g.slice(n+1)))}}function P(g){return"<div>"+E(g)+"</div>"}function w(g){var n=h;l.each(g,function(j,t){n=l(P(t)).insertAfter(n).addClass("clear")})}function r(g){l.each(g,function(n,j){b.before(P(j))})}var b=k.prev(),h=k.next();return function(){var g=V?a.replace(/./g,"*"):a,n;c.find("div").remove();b.html("");if(g.length>A-L-1||g.match(/\n/)){var j,t=g.match(/\t/g),s=t?t.length*3:0;if(t)g=g.replace(/\t/g,
"\u0000\u0000\u0000\u0000");if(g.match(/\n/)){var v=g.split("\n"),u=A-L-1;for(n=0;n<v.length-1;++n)v[n]+=" ";if(v[0].length>u){j=[v[0].substring(0,u)];j=j.concat(X(v[0].substring(u),A))}else j=[v[0]];for(n=1;n<v.length;++n)if(v[n].length>A)j=j.concat(X(v[n],A));else j.push(v[n])}else j=m(g);if(t)j=l.map(j,function(Z){return Z.replace(/\x00\x00\x00\x00/g,"\t")});u=j[0].length;if(o<u){q(j[0],o);w(j.slice(1))}else if(o==u){b.before(P(j[0]));q(j[1],0);w(j.slice(2))}else{n=j.length;if(o<u){q(j[0],o);w(j.slice(1))}else if(o==
u){b.before(P(j[0]));q(j[1],0);w(j.slice(2))}else{t=j.slice(-1)[0];v=g.length-o;var I=t.length;g=0;if(v<=I){r(j.slice(0,-1));q(t,(I==v?0:I-v)+s)}else if(n==3){b.before("<div>"+E(j[0])+"</div>");q(j[1],o-u-1);h.after('<div class="clear">'+E(j[2])+"</div>")}else{g=o;for(n=0;n<j.length;++n){s=j[n].length;if(g>s)g-=s;else break}s=j[n];u=n;if(g==s.length){g=0;s=j[++u]}q(s,g);r(j.slice(0,u));w(j.slice(u+1))}}}}else if(g===""){b.html("");k.html("&nbsp;");h.html("")}else q(g,o)}}(p),H=function(){var c=p.find(".prompt");
return function(){if(typeof z=="string"){L=z.replace(Y,"$4").length;c.html(E(z))}else z(function(q){L=q.replace(Y,"$4").length;c.html(E(q))})}}();l.extend(p,{name:function(c){if(c!==B){K=c;D=new na(c)}else return K},history:function(){return D},set:function(c,q){if(c!==B){a=c;if(!q)o=a.length;x();if(typeof d.onCommandChange=="function")d.onCommandChange(a)}},insert:function(c,q){if(o==a.length)a+=c;else a=o===0?c+a:a.slice(0,o)+c+a.slice(o);q||(o+=c.length);x();if(typeof d.onCommandChange=="function")d.onCommandChange(a)},
get:function(){return a},commands:function(c){if(c)d.commands=c;else return c},destroy:function(){l(document.documentElement).unbind(".commandline");p.find(".prompt").remove()},prompt:function(c){if(c===B)return z;else{if(typeof c=="string"||typeof c=="function")z=c;else throw"prompt must be a function or string";H();x()}},position:function(c){if(typeof c=="number"){o=c<0?0:c>a.length?a.length:c;x()}else return o},show:function(){var c=p.show;return function(){c.apply(p,[]);x();H()}}(),resize:function(c){if(c)A=
c;else{c=p.width();var q=k.innerWidth();A=Math.floor(c/q)}x()},enable:function(){if(!M){k.addClass("inverted");p.everyTime(500,"blink",e);M=true}},isenabled:function(){return M},disable:function(){if(M){p.stopTime("blink",e);k.removeClass("inverted");M=false}},mask:function(c){if(typeof c=="boolean"){V=c;x()}else return V}});p.name(d.name||"");z=d.prompt||"> ";H();if(d.enabled===B||d.enabled===true)p.enable();l(l.browser.msie?document.documentElement:window).keypress(function(c){var q;if(c.ctrlKey&&
c.which==99)return true;if(!G&&d.keypress)q=d.keypress(c);if(q===B||q){if(M)if([38,32,13,0,8].has(c.which)&&c.keyCode!=123&&!(c.which==38&&c.shiftKey))return false;else if(!c.ctrlKey&&!(c.altKey&&c.which==100)){if(G){F+=String.fromCharCode(c.which);f();i()}else p.insert(String.fromCharCode(c.which));return false}else if(c.altKey)if(G){F+=String.fromCharCode(c.which);f();i()}else p.insert(String.fromCharCode(c.which))}else return q}).keydown(C);return p};l.jrpc=function(d,e,f,i,m,y){e=l.json_stringify({jsonrpc:"2.0",
method:f,params:i,id:e});return l.ajax({url:d,data:e,success:m,error:y,contentType:"application/json",dataType:"json",async:true,cache:false,type:"POST"})};T=/ {14}$/;var oa=[["jQuery Terminal","(c) 2011 jcubic"],["JQuery Terminal Emulator v. 0.4.16","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,"")],["JQuery Terminal Emulator version version 0.4.16","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      _______                 ________                        __",
"     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /","/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\__/____/_/ \\__ / /_/____/_//_/ /_/ /_/  \\/\\__\\_\\___/","         \\/          /____/                                   ".replace(T,"")+"version 0.4.16","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      __ _____                     ________                              __",
"     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /","/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                          ".replace(T,"")+"version 0.4.16","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],$=[],N=new function(d){var e=
d?[d]:[],f=0;l.extend(this,{rotate:function(){if(e.length==1)return e[0];else{if(f==e.length-1)f=0;else++f;return e[f]}},length:function(){return e.length},set:function(i){for(var m=e.length;m--;)if(e[m]===i){f=m;return}this.append(i)},front:function(){return e[f]},append:function(i){e.push(i)}})};l.fn.terminal=function(d,e){function f(){return a.get(0).scrollHeight>a.innerHeight()}function i(){var b=a.find(".cursor").width(),h=Math.floor(a.width()/b);if(f()){var g=a.innerWidth()-a.width();h-=Math.ceil((20-
g/2)/(b-1))}return h}function m(b,h){a.error("&#91;"+h+"&#93;: "+(typeof b=="string"?b:b.fileName+": "+b.message));a.pause();typeof b.fileName=="string"&&l.get(b.fileName,function(g){a.resume();var n=b.lineNumber-1;(g=g.split("\n")[n])&&a.error("&#91;"+b.lineNumber+"&#93;: "+g)})}function y(b,h){try{if(typeof h=="function")h(function(){});else if(typeof h!="string")throw b+" must be string or function";}catch(g){m(g,b.toUpperCase());return false}return true}function C(){var b=a.prop?a.prop("scrollHeight"):
a.attr("scrollHeight");a.scrollTop(b)}function p(b){b=typeof b=="string"?b:String(b);var h,g,n;if(b.length>K){h=K;g=b.split(/\n/g);n=/(\[\[[bius]*;[^;]*;[^\]]*\][^\]\[]*\]?)/g;var j=/(\[\[[bius]*;[^;]*;[^\]]*\])/,t=/\[\[[bius]*;?[^;]*;?[^\]]*\]?$/,s=false,v=false,u="";b=[];for(var I=0,Z=g.length;I<Z;++I){if(u!=="")if(g[I]===""){b.push(u+"]");continue}else{g[I]=u+g[I];u=""}else if(g[I]===""){b.push("");continue}for(var W=g[I],ea=0,aa=0,R=0,fa=W.length;R<fa;++R){if(W[R]=="["&&W[R+1]=="[")s=true;else if(s&&
W[R]=="]")if(v)v=s=false;else v=true;else if(s&&v||!s)++aa;if(aa==h||R==fa-1){var O=W.substring(ea,R+1);if(u){O=u+O;if(O.match("]"))u=""}ea=R+1;aa=0;var S=O.match(n);if(S){S=S[S.length-1];if(S[S.length-1]!="]"){u=S.match(j)[1];O+="]"}else if(O.match(t)){O=O.replace(t,"");u=S.match(j)[1]}}b.push(O)}}}h=l("<div></div>");g=0;for(n=b.length;g<n;++g)b[g]===""||b[g]=="\r"?h.append("<div>&nbsp;</div>"):l("<div/>").html(E(b[g])).appendTo(h)}else h=l("<div/>").html(E(b));z.append(h);h.width("100%");C();return h}
function J(b,h){var g=1,n=function(j,t){h.pause();l.jrpc(b,g++,j,t,function(s){if(s.error)h.error("&#91;RPC&#93; "+s.error.message);else if(typeof s.result=="string")h.echo(s.result);else if(s.result instanceof Array)h.echo(s.result.join(" "));else if(typeof s.result=="object"){var v="",u;for(u in s.result)if(s.result.hasOwnProperty(u))v+=u+": "+s.result[u]+"\n";h.echo(v)}h.resume()},function(s,v){h.error("&#91;AJAX&#93; "+v+" - Server reponse is: \n"+s.responseText);h.resume()})};return function(j,
t){if(j!==""){var s,v;if(j.match(/[^ ]* /)){j=j.split(/ +/);s=j[0];v=j.slice(1)}else{s=j;v=[]}if(!k.login||s=="help")n(s,v);else{var u=t.token();u?n(s,[u].concat(v)):t.error("&#91;AUTH&#93; Access denied (no token)")}}}}function A(b){var h=r.prompt();if(r.mask())b=b.replace(/./g,"*");typeof h=="function"?h(function(g){a.echo(g+b)}):a.echo(h+b)}function L(b){try{var h=w.top();if(b=="exit"&&k.exit)if(w.size()==1)if(k.login)F();else{A(b);a.echo("You can exit from main interpeter")}else a.pop("exit");
else{A(b);b=="clear"&&k.clear?a.clear():h.eval(b,a)}}catch(g){m(g,"USER");a.resume();throw g;}}function G(){var b=null;r.prompt("login: ");k.history&&r.history().disable();r.commands(function(h){try{A(h);if(b){r.mask(false);a.pause();if(typeof k.login!="function")throw"Value of login property must be a function";k.login(b,h,function(n){if(n){var j=k.name;j=j?"_"+j:"";l.Storage.set("token"+j,n);l.Storage.set("login"+j,b);r.commands(L);U()}else{a.error("Wrong password try again");r.prompt("login: ");
b=null}a.resume();k.history&&r.history().enable()})}else{b=h;r.prompt("password: ");r.mask(true)}}catch(g){m(g,"LOGIN",a);throw g;}})}function F(){var b=k.name;b=b?"_"+b:"";l.Storage.remove("token"+b,null);l.Storage.remove("login"+b,null);k.history&&r.history().disable();G()}function Q(){var b=w.top(),h="";if(b.name!==B&&b.name!=="")h+=b.name+"_";h+=M;r.name(h);b.prompt.constructor==Function?r.prompt(function(g){b.prompt(g,a)}):r.prompt(b.prompt);k.history&&r.history().enable();r.set("");if(typeof b.onStart==
"function")b.onStart(a)}function U(){Q();if(e.greetings===B)a.echo(a.signature);else e.greetings&&a.echo(e.greetings);if(typeof k.onInit=="function")k.onInit(a)}function V(b){a.oneTime(5,function(){if(c!=f()){a.resize();c=f()}});if(a.paused()){if(k.cancelableAjax)if(b.which==68&&b.ctrlKey){for(b=$.length;b--;){var h=$[b];if(4!=h.readyState)try{h.abort()}catch(g){a.error("error in aborting ajax")}}a.resume();return false}}else{if(k.keydown&&k.keydown(b,a)===false)return false;if(b.which!=9)H=0;if(b.which==
68&&b.ctrlKey){if(r.get()==="")if(w.size()>1||k.login!==B)a.pop("");else{a.resume();a.echo("")}else a.set_command("");return false}else if(k.tabcompletion&&b.which==9){++H;h=r.get();if(!h.match(" ")){var n=RegExp("^"+h),j=w.top().command_list,t=[];for(b=j.length;b--;)n.test(j[b])&&t.push(j[b]);if(t.length==1)a.set_command(t[0]);else if(t.length>1)if(H>=2){A(h);a.echo(t.join("\t"));H=0}}return false}else if(b.which==86&&b.ctrlKey){a.oneTime(1,function(){C()});return true}else if(b.which==9&&b.ctrlKey){N.length()>
1&&a.focus(false);return false}else if(b.which==34)a.scroll(a.height());else b.which==33?a.scroll(-a.height()):a.attr({scrollTop:a.attr("scrollHeight")})}}var a=this,o=[],z,M=N.length(),K,D=[],k={name:"",prompt:"> ",history:true,exit:true,clear:true,enabled:true,cancelableAjax:true,login:null,tabcompletion:null,historyFilter:null,onInit:null,onExit:null,keypress:null,keydown:null};if(e){e.width&&a.width(e.width);e.height&&a.height(e.height);l.extend(k,e)}var x=!k.enabled;if(a.length===0)throw'Sorry, but terminal said that "'+
a.selector+'" is not valid selector!';a.ajaxSend(function(b,h){$.push(h)});if(a.data("terminal"))return a.data("terminal");z=l("<div>").addClass("terminal-output").appendTo(a);a.addClass("terminal").append("<div/>");l.extend(a,{clear:function(){z.html("");r.set("");o=[];a.attr({scrollTop:0});return a},paused:function(){return x},pause:function(){if(r){a.disable();r.hide()}return a},resume:function(){if(r){a.enable();r.show();C()}return a},cols:function(){return K},rows:function(){return o.length},
history:function(){return r.history()},next:function(){if(N.length()==1)return a;else{var b=a.offset().top;a.height();a.scrollTop();var h=a,g=l(window).scrollTop(),n=g+l(window).height(),j=l(h).offset().top;if(j+l(h).height()>=g&&j<=n){N.front().disable();b=N.rotate().enable();h=b.offset().top-50;l("html,body").animate({scrollTop:h},500);return b}else{a.enable();l("html,body").animate({scrollTop:b-50},500);return a}}},focus:function(b){a.oneTime(1,function(){if(N.length()==1)b===false?a.disable():
a.enable();else if(b===false)a.next();else{N.front().disable();N.set(a);a.enable()}});return a},enable:function(){K===B&&a.resize();if(x)if(r){r.enable();x=false}return a},disable:function(){if(r){x=true;r.disable()}return a},enabled:function(){return x},signature:function(){var b=a.cols();b=b<15?null:b<35?0:b<55?1:b<64?2:b<75?3:4;return b!==null?oa[b].join("\n")+"\n":""},version:function(){return"0.4.16"},get_command:function(){return r.get()},insert:function(b){if(typeof b=="string"){r.insert(b);
return a}else throw"insert function argument is not a string";},set_prompt:function(b){if(y("prompt",b)){b.constructor==Function?r.prompt(function(h){b(h,a)}):r.prompt(b);w.top().prompt=b}return a},get_prompt:function(){return w.top().prompt},set_command:function(b){r.set(b);return a},set_mask:function(b){r.mask(b);return a},get_output:function(b){return b?o:l.map(o,function(h,g){return typeof g=="function"?g():g}).get().join("\n")},resize:function(b,h){if(b&&h){a.width(b);a.height(h)}console.log(K);
K=i();r.resize(K);var g=z.detach();z.html("");l.each(o,function(n,j){p(j.constructor==Function?j():j)});a.prepend(g);C();return a},echo:function(b){o.push(b);return p(typeof b=="function"?b():b)},error:function(b){a.echo("[[;#f00;]"+b.replace(/\[/g,"&#91;").replace(/\]/g,"&#93;")+"]")},scroll:function(b){var h;if(a.prop){b>a.prop("scrollTop")&&b>0&&a.prop("scrollTop",0);h=a.prop("scrollTop");a.prop("scrollTop",h+b)}else{b>a.attr("scrollTop")&&b>0&&a.attr("scrollTop",0);h=a.attr("scrollTop");a.attr("scrollTop",
h+b)}return a},logout:k.login?function(){for(;w.size()>1;)w.pop();F();return a}:function(){throw"You don't have login function";},token:k.login?function(){var b=k.name;return l.Storage.get("token"+(b?"_"+b:""))}:null,login_name:k.login?function(){var b=k.name;return l.Storage.get("login"+(b?"_"+b:""))}:null,name:function(){return k.name},push:function(b,h){if(!h.prompt||y("prompt",h.prompt)){if(typeof b=="string")b=J(h.eval,a);w.push(l.extend({eval:b},h));Q()}return a},pop:function(b){b!==B&&A(b);
if(w.top().name===k.name){if(k.login){F();if(typeof k.onExit=="function")k.onExit(a)}}else{b=w.pop();Q();if(typeof b.onExit=="function")b.onExit(a)}return a}});var H=0,c=f(),q;if(k.login&&typeof k.onBeforeLogin=="function")k.onBeforeLogin(a);if(d.constructor==String){q=d;d=J(d,a)}else if(d.constructor==Array)throw"You can't use array as eval";else if(typeof d=="object"){for(var P in d)D.push(P);d=function b(h){return function(g){if(g!==""){g=g.split(/ +/);var n=g[0],j=g.slice(1);g=h[n];var t=typeof g;
if(t=="function")g.apply(a,j);else if(t=="object"||t=="string"){j=[];if(t=="object"){for(var s in g)j.push(s);g=b(g)}a.push(g,{prompt:n+"> ",name:n,command_list:j})}else a.error("Command '"+n+"' Not Found")}}}(d)}else if(typeof d!="function")throw'Unknow object "'+String(d)+'" passed as eval';if(q&&(typeof k.login=="string"||k.login))k.login=function(b){var h=1;return function(g,n,j){a.pause();l.jrpc(q,h++,b,[g,n],function(t){a.resume();!t.error&&t.result?j(t.result):j(null)},function(t,s){a.resume();
a.error("&#91;AJAX&#92; Response: "+s+"\n"+t.responseText)})}}(typeof k.login=="boolean"?"login":k.login);if(y("prompt",k.prompt)){var w=new ma({name:k.name,eval:d,prompt:k.prompt,command_list:D,greetings:k.greetings}),r=a.find(".terminal-output").next().cmd({prompt:k.prompt,history:k.history,historyFilter:k.historyFilter,width:"100%",keydown:V,keypress:k.keypress?function(b){return k.keypress(b,a)}:null,onCommandChange:function(b){if(typeof k.onCommandChange=="function")k.onCommandChange(b,a);C()},
commands:L});N.append(a);k.enabled===true?a.focus():a.disable();l(window).resize(a.resize);a.click(function(){a.focus()});a.token&&!a.token()&&a.login_name&&!a.login_name()?G():U();typeof l.fn.init.prototype.mousewheel==="function"&&a.mousewheel(function(b,h){h>0?a.scroll(-40):a.scroll(40);return false},true)}a.data("terminal",a);return a}})(jQuery);
