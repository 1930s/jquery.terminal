/*

 |       __ _____                     ________                              __
 |      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 |  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 | /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 | \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 |           \/              /____/                              version 0.4.5
 http://terminal.jcubic.pl

 Licensed under GNU LGPL Version 3 license
 Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>

 Includes:

 Storage plugin Distributed under the MIT License
 Copyright (c) 2010 Dave Schindler

 LiveQuery plugin Dual MIT and GPL
 Copyright (c) 2008 Brandon Aaron (http://brandonaaron.net)

 jQuery Timers licenced with the WTFPL
 <http://jquery.offput.ca/every/>

 Date: Thu, 05 Jan 2012 21:36:15 +0000
*/
Array.prototype.has=function(g){for(var B=this.length;B--;)if(this[B]==g)return true;return false};function get_stack(g){return g?[g.toString().match(/.*\n.*\n/)].concat(get_stack(g.caller)):[]}
(function(g,B){function $(b,d){var e;if(typeof b==="string"&&typeof d==="string"){localStorage[b]=d;return true}else if(typeof b==="object"&&typeof d==="undefined"){for(e in b)if(b.hasOwnProperty(e))localStorage[e]=b[e];return true}return false}function X(b,d){var e,i;e=new Date;e.setTime(e.getTime()+31536E6);e="; expires="+e.toGMTString();if(typeof b==="string"&&typeof d==="string"){document.cookie=b+"="+d+e+"; path=/";return true}else if(typeof b==="object"&&typeof d==="undefined"){for(i in b)if(b.hasOwnProperty(i))document.cookie=
i+"="+b[i]+e+"; path=/";return true}return false}function aa(b){return localStorage[b]}function ba(b){var d,e,i;b+="=";d=document.cookie.split(";");for(e=0;e<d.length;e++){for(i=d[e];i.charAt(0)===" ";)i=i.substring(1,i.length);if(i.indexOf(b)===0)return i.substring(b.length,i.length)}return null}function ca(b){return delete localStorage[b]}function da(b){return X(b,"",-1)}function W(b,d){var e=[],i=b.length;if(i<d)return[b];for(var h=0;h<i;h+=d)e.push(b.substring(h,h+d));return e}function H(b){if(typeof b==
"string"){b=b.replace(/&(?!#[0-9]*;)/g,"&amp;");b=b.replace(/</g,"&lt;").replace(/>/g,"&gt;");b=b.replace(/\n/g,"<br/>");b=b.replace(/ /g,"&nbsp;");b=b.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");var d=b.split(ea);if(d.length>1)b=g.map(d,function(e){return e===""?e:e[0]=="["?e.replace(fa,function(i,h,u,y,D){if(D==="")return"<span>&nbsp;</span>";i="";if(h.indexOf("b")!=-1)i+="font-weight:bold;";if(h.indexOf("u")!=-1)i+="text-decoration:underline;";if(h.indexOf("i")!=-1)i+="font-style:italic; ";if(u.match(Y))i+=
"color:"+u+";";if(y.match(Y))i+="background-color:"+y;return b='<span style="'+i+'">'+D+"</span>"}):"<span>"+e+"</span>"}).join("");return b}else return""}function Z(b){var d=b instanceof Array?b:b?[b]:[],e=0;g.extend(this,{left:function(){if(e===0)e=d.length-1;else--e;return d[e]},right:function(){if(e==d.length-1)e=0;else++e;return d[e]},current:function(){return d[e]},data:function(){return d},length:function(){return d.length},reset:function(){e=0},append:function(i){d.push(i);this.reset()}})}
function ga(b){var d=b?[b]:[];g.extend(this,{size:function(){return d.length},pop:function(){if(d.length===0)return null;else{var e=d[d.length-1];d=d.slice(0,d.length-1);return e}},push:function(e){d=d.concat([e]);return e},top:function(){return d.length>0?d[d.length-1]:null}})}function ha(b){var d=true;if(typeof b==="string"&&b!=="")b+="_";var e=g.Storage.get(b+"commands"),i=new Z(e?eval("("+e+")"):[""]);g.extend(this,{append:function(h){if(d&&i.current()!=h){i.append(h);g.Storage.set(b+"commands",
g.json_stringify(i.data()))}},data:function(){return i.data()},next:function(){return i.right()},last:function(){i.reset()},previous:function(){return i.left()},clear:function(){i=new Z;g.Storage.remove(b+"commands")},enable:function(){d=true},disable:function(){d=false}})}g.extend(g.fn,{livequery:function(b,d,e){var i=this,h;if(g.isFunction(b)){e=d;d=b;b=B}g.each(g.livequery.queries,function(u,y){if(i.selector==y.selector&&i.context==y.context&&b==y.type&&(!d||d.$lqguid==y.fn.$lqguid)&&(!e||e.$lqguid==
y.fn2.$lqguid))return(h=y)&&false});h=h||new g.livequery(this.selector,this.context,b,d,e);h.stopped=false;h.run();return this},expire:function(b,d,e){var i=this;if(g.isFunction(b)){e=d;d=b;b=B}g.each(g.livequery.queries,function(h,u){if(i.selector==u.selector&&i.context==u.context&&(!b||b==u.type)&&(!d||d.$lqguid==u.fn.$lqguid)&&(!e||e.$lqguid==u.fn2.$lqguid)&&!this.stopped)g.livequery.stop(u.id)});return this}});g.livequery=function(b,d,e,i,h){this.selector=b;this.context=d||document;this.type=
e;this.fn=i;this.fn2=h;this.elements=[];this.stopped=false;this.id=g.livequery.queries.push(this)-1;i.$lqguid=i.$lqguid||g.livequery.guid++;if(h)h.$lqguid=h.$lqguid||g.livequery.guid++;return this};g.livequery.prototype={stop:function(){var b=this;if(this.type)this.elements.unbind(this.type,this.fn);else this.fn2&&this.elements.each(function(d,e){b.fn2.apply(e)});this.elements=[];this.stopped=true},run:function(){if(!this.stopped){var b=this,d=this.elements,e=g(this.selector,this.context),i=e.not(d);
this.elements=e;if(this.type){i.bind(this.type,this.fn);d.length>0&&g.each(d,function(h,u){g.inArray(u,e)<0&&g.event.remove(u,b.type,b.fn)})}else{i.each(function(){b.fn.apply(this)});this.fn2&&d.length>0&&g.each(d,function(h,u){g.inArray(u,e)<0&&b.fn2.apply(u)})}}}};g.extend(g.livequery,{guid:0,queries:[],queue:[],running:false,timeout:null,checkQueue:function(){if(g.livequery.running&&g.livequery.queue.length)for(var b=g.livequery.queue.length;b--;)g.livequery.queries[g.livequery.queue.shift()].run()},
pause:function(){g.livequery.running=false},play:function(){g.livequery.running=true;g.livequery.run()},registerPlugin:function(){g.each(arguments,function(b,d){if(g.fn[d]){var e=g.fn[d];g.fn[d]=function(){var i=e.apply(this,arguments);g.livequery.run();return i}}})},run:function(b){if(b!=B)g.inArray(b,g.livequery.queue)<0&&g.livequery.queue.push(b);else g.each(g.livequery.queries,function(d){g.inArray(d,g.livequery.queue)<0&&g.livequery.queue.push(d)});g.livequery.timeout&&clearTimeout(g.livequery.timeout);
g.livequery.timeout=setTimeout(g.livequery.checkQueue,20)},stop:function(b){b!=B?g.livequery.queries[b].stop():g.each(g.livequery.queries,function(d){g.livequery.queries[d].stop()})}});g.livequery.registerPlugin("append","prepend","after","before","wrap","attr","removeAttr","addClass","removeClass","toggleClass","empty","remove");g(function(){g.livequery.play()});var ia=g.prototype.init;g.prototype.init=function(b,d){var e=ia.apply(this,arguments);if(b&&b.selector){e.context=b.context;e.selector=
b.selector}if(typeof b=="string"){e.context=d||document;e.selector=b}return e};g.prototype.init.prototype=g.prototype;var S=typeof window.localStorage!=="undefined";g.extend({Storage:{set:S?$:X,get:S?aa:ba,remove:S?ca:da}});jQuery.fn.extend({everyTime:function(b,d,e,i,h){return this.each(function(){jQuery.timer.add(this,b,d,e,i,h)})},oneTime:function(b,d,e){return this.each(function(){jQuery.timer.add(this,b,d,e,1)})},stopTime:function(b,d){return this.each(function(){jQuery.timer.remove(this,b,d)})}});
jQuery.extend({timer:{guid:1,global:{},regex:/^([0-9]+)\s*(.*s)?$/,powers:{ms:1,cs:10,ds:100,s:1E3,das:1E4,hs:1E5,ks:1E6},timeParse:function(b){if(b==B||b===null)return null;var d=this.regex.exec(jQuery.trim(b.toString()));return d[2]?parseInt(d[1],10)*(this.powers[d[2]]||1):b},add:function(b,d,e,i,h,u){var y=0;if(jQuery.isFunction(e)){h||(h=i);i=e;e=d}d=jQuery.timer.timeParse(d);if(!(typeof d!="number"||isNaN(d)||d<=0)){if(h&&h.constructor!=Number){u=!!h;h=0}h=h||0;u=u||false;if(!b.$timers)b.$timers=
{};b.$timers[e]||(b.$timers[e]={});i.$timerID=i.$timerID||this.guid++;var D=function(){if(!(u&&this.inProgress)){this.inProgress=true;if(++y>h&&h!==0||i.call(b,y)===false)jQuery.timer.remove(b,e,i);this.inProgress=false}};D.$timerID=i.$timerID;b.$timers[e][i.$timerID]||(b.$timers[e][i.$timerID]=window.setInterval(D,d));this.global[e]||(this.global[e]=[]);this.global[e].push(b)}},remove:function(b,d,e){var i=b.$timers,h;if(i){if(d){if(i[d]){if(e){if(e.$timerID){window.clearInterval(i[d][e.$timerID]);
delete i[d][e.$timerID]}}else for(e in i[d]){window.clearInterval(i[d][e]);delete i[d][e]}for(h in i[d])break;if(!h){h=null;delete i[d]}}}else for(d in i)this.remove(b,d,e);for(h in i)break;if(!h)b.$timers=null}}}});if(jQuery.browser.msie)jQuery(window).one("unload",function(){var b=jQuery.timer.global,d;for(d in b)for(var e=b[d],i=e.length;--i;)jQuery.timer.remove(e[i],d)});var ea=/(\[\[[biu]*;[^;]*;[^\]]*\][^\]\[]*\])/g,fa=/\[\[([biu]*);([^;]*);([^\]]*)\]([^\]\[]*)\]/g,Y=/#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})/;
g.json_stringify=function(b,d){var e="",i;d=d===B?1:d;switch(typeof b){case "function":e+=b;break;case "boolean":e+=b?"true":"false";break;case "object":if(b===null)e+="null";else if(b instanceof Array){e+="[";var h=b.length;for(i=0;i<h-1;++i)e+=g.json_stringify(b[i],d+1);e+=g.json_stringify(b[h-1],d+1)+"]"}else{e+="{";for(h in b)if(b.hasOwnProperty(h))e+='"'+h+'":'+g.json_stringify(b[h],d+1);e+="}"}break;case "string":h=b;var u={"\\\\":"\\\\",'"':'\\"',"/":"\\/","\\n":"\\n","\\r":"\\r","\\t":"\\t"};
for(i in u)if(u.hasOwnProperty(i))h=h.replace(RegExp(i,"g"),u[i]);e+='"'+h+'"';break;case "number":e+=String(b)}e+=d>1?",":"";if(d==1)e=e.replace(/,([\]}])/g,"$1");return e.replace(/([\[{]),/g,"$1")};g.fn.cmd=function(b){function d(){N.toggleClass("inverted")}function e(f){var s=f.substring(0,y-D-1);f=f.substring(y-D-1);return[s].concat(W(f,y))}function i(){u.focus();h.oneTime(1,function(){h.insert(u.val());u.blur();u.val("")})}var h=this;h.addClass("cmd");h.append('<span class="prompt"></span><span></span><span class="cursor">&nbsp;</span><span></span>');
var u=g("<textarea/>").addClass("clipboard").appendTo(h);b.width&&h.width(b.width);var y,D,T=b.mask||false,m="",n=0,K,L=b.enabled,U,I,N=h.find(".cursor"),c=function(f){function s(t,v){if(v==t.length){E.html(H(t));N.html("&nbsp;");J.html("")}else if(v===0){E.html("");N.html(H(t.slice(0,1)));J.html(H(t.slice(1)))}else{var o=H(t.slice(0,v));E.html(o);o=t.slice(v,v+1);N.html(o==" "?"&nbsp;":H(o));v==t.lenght-1?J.html(""):J.html(H(t.slice(v+1)))}}function M(t){return"<div>"+H(t)+"</div>"}function R(t){var v=
J;g.each(t,function(o,z){v=g(M(z)).insertAfter(v).addClass("clear")})}function l(t){g.each(t,function(v,o){E.before(M(o))})}var E=N.prev(),J=N.next();return function(){var t=T?m.replace(/./g,"*"):m,v;f.find("div").remove();E.html("");if(t.length>y-D-1||t.match(/\n/)){var o,z=t.match(/\t/g),q=z?z.length*3:0;if(z)t=t.replace(/\t/g,"\u0000\u0000\u0000\u0000");if(t.match(/\n/)){var a=t.split("\n"),j=y-D-1;for(v=0;v<a.length-1;++v)a[v]+=" ";if(a[0].length>j){o=[a[0].substring(0,j)];o=o.concat(W(a[0].substring(j),
y))}else o=[a[0]];for(v=1;v<a.length;++v)if(a[v].length>y)o=o.concat(W(a[v],y));else o.push(a[v])}else o=e(t);if(z)o=g.map(o,function(k){return k.replace(/\x00\x00\x00\x00/g,"\t")});j=o[0].length;if(n<j){s(o[0],n);R(o.slice(1))}else if(n==j){E.before(M(o[0]));s(o[1],0);R(o.slice(2))}else{v=o.length;if(n<j){s(o[0],n);R(o.slice(1))}else if(n==j){E.before(M(o[0]));s(o[1],0);R(o.slice(2))}else{z=o.slice(-1)[0];a=t.length-n;t=0;if(a<=z.length){l(o.slice(0,-1));t=z.length==a?0:z.length-a;s(z,t+q)}else if(v==
3){E.before("<div>"+H(o[0])+"</div>");s(o[1],n-j-1);J.after('<div class="clear">'+H(o[2])+"</div>")}else{t=n;for(v=0;v<o.length;++v)if(t>o[v].length)t-=o[v].length;else break;q=o[v];j=v;if(t==q.length){t=0;q=o[++j]}s(q,t);l(o.slice(0,j));R(o.slice(j+1))}}}}else if(t===""){E.html("");N.html("&nbsp;");J.html("")}else s(t,n)}}(h),O=function(){var f=h.find(".prompt");return function(){if(typeof K=="string"){D=K.length;f.html(H(K)+"&nbsp;")}else K(function(s){D=s.length;f.html(H(s)+"&nbsp;")})}}();g.extend(h,
{name:function(f){if(f!==B){U=f;I=new ha(f)}else return U},history:function(){return I},set:function(f,s){if(f!==B){m=f;if(!s)n=m.length;c()}},insert:function(f,s){if(n==m.length)m+=f;else m=n===0?f+m:m.slice(0,n)+f+m.slice(n);s||(n+=f.length);c()},get:function(){return m},commands:function(f){if(f)b.commands=f;else return f},destroy:function(){g(document.documentElement).unbind(".commandline");h.find(".prompt").remove()},prompt:function(f){if(f===B)return K;else{if(typeof f=="string"||typeof f==
"function")K=f;else throw"prompt must be a function or string";O()}},position:function(f){if(typeof f=="number"){n=f<0?0:f>m.length?m.length:f;c()}else return n},resize:function(f){if(f)y=f;else{f=h.width();var s=N.innerWidth();y=Math.floor(f/s)}c()},enable:function(){if(!L){h.everyTime(500,"blink",d);L=true}},isenabled:function(){return L},disable:function(){if(L){h.stopTime("blink",d);h.find(".cursor").removeClass("inverted");L=false}},mask:function(f){if(typeof f=="boolean"){T=f;c()}else return T}});
h.name(b.name||"");K=b.prompt||">";O();if(b.enabled===B||b.enabled===true)h.enable();g(document.documentElement).keypress(function(f){var s;if(f.ctrlKey&&f.which==99)return true;if(b.keypress)s=b.keypress(f);if(s===B||s){if(L)if([38,32,13,0,8].has(f.which)&&f.keyCode!=123&&!(f.which==38&&f.shiftKey))return false;else if(!f.ctrlKey&&!(f.altKey&&f.which==100)){h.insert(String.fromCharCode(f.which));return false}}else return s}).keydown(function(f){if(L){if(b.keydown&&b.keydown(f)===false)return false;
var s;if(f.keyCode==13){I&&m&&I.append(m);I.last();f=m;h.set("");typeof K=="function"&&O();b.commands&&b.commands(f)}else if(f.which==32)h.insert(" ");else if(f.which==8){if(m!==""&&n>0){m=m.slice(0,n-1)+m.slice(n,m.length);--n;c()}}else if(f.which==9&&!(f.ctrlKey||f.altKey))h.insert("\t");else if(f.which==46){if(m!==""&&n<m.length){m=m.slice(0,n)+m.slice(n+1,m.length);c()}return true}else if(I&&f.which==38||f.which==80&&f.ctrlKey)h.set(I.previous());else if(I&&f.which==40||f.which==78&&f.ctrlKey)h.set(I.next());
else if(f.which==37||f.which==66&&f.ctrlKey)if(f.ctrlKey&&f.which!=66){s=n-1;f=0;for(m[s]==" "&&--s;s>0;--s)if(m[s]==" "&&m[s+1]!=" "){f=s+1;break}else if(m[s]=="\n"&&m[s+1]!="\n"){f=s;break}h.position(f)}else{if(n>0){--n;c()}}else if(f.which==39||f.which==70&&f.ctrlKey)if(f.ctrlKey&&f.which!=70){m[n]==" "&&++n;f=m.slice(n).match(/\S[\n\s]{2,}|[\n\s]+\S?/);if(!f||f[0].match(/^\s+$/))n=m.length;else if(f[0][0]!=" ")n+=f.index+1;else{n+=f.index+f[0].length-1;f[0][f[0].length-1]!=" "&&--n}c()}else{if(n<
m.length){++n;c()}}else if(f.which==123)return true;else if(f.which==36)h.position(0);else if(f.which==35)h.position(m.length);else if(f.ctrlKey||f.metaKey)if(f.shiftKey){if(f.which==84)return true}else if(f.which==65)h.position(0);else if(f.which==69)h.position(m.length);else if(f.which==88||f.which==67||f.which==87||f.which==84)return true;else if(f.which==86){i();return true}else if(f.which==75)if(n===0)h.set("");else n!=m.length&&h.set(m.slice(0,n));else if(f.which==85)h.set("");else{if(f.which==
17)return true}else if(f.altKey)f.which==68&&h.set(m.slice(0,n)+m.slice(n).replace(/[^ ]+ |[^ ]+$/,""),true);else return true;return false}});return h};g.jrpc=function(b,d,e,i,h,u){d=g.json_stringify({jsonrpc:"2.0",method:e,params:i,id:d});return g.ajax({url:b,data:d,success:h,error:u,contentType:"application/json",dataType:"json",async:true,cache:false,type:"POST"})};S=/ {13}$/;var ja=[["jQuery Terminal","(c) 2011 jcubic"],["JQuery Terminal Emulator v. 0.4.5","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>".replace(/ *<.*>/,
"")],["JQuery Terminal Emulator version version 0.4.5","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      _______                 ________                        __","     / / _  /_ ____________ _/__  ___/______________  _____  / /"," __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /","/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__","\\___/____ \\\\__/____/_/ \\__ / /_/____/_//_/ /_/ /_/  \\/\\__\\_\\___/","         \\/          /____/                                   ".replace(S,
"")+"version 0.4.5","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"],["      __ _____                     ________                              __","     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /"," __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ \\/ /","/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // / /__","\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\__\\_\\___/","          \\/              /____/                                          ".replace(S,
"")+"version 0.4.5","Copyright (c) 2011 Jakub Jankiewicz <http://jcubic.pl>"]],ka=[],P=new function(b){var d=b?[b]:[],e=0;g.extend(this,{rotate:function(){if(d.length==1)return d[0];else{if(e==d.length-1)e=0;else++e;return d[e]}},length:function(){return d.length},set:function(i){for(var h=d.length;h--;)if(d[h]===i){e=h;return}this.append(i)},front:function(){return d[e]},append:function(i){d.push(i)}})};g.fn.terminal=function(b,d){function e(){return c.get(0).scrollHeight>c.innerHeight()}function i(){var a=
c.find(".cursor");a=Math.floor(c.width()/a.width());if(e())a-=2;return a}function h(a,j){c.error("&#91;"+j+"&#93;: "+(typeof a=="string"?a:a.fileName+": "+a.message));c.pause();typeof a.fileName=="string"&&g.get(a.fileName,function(k){c.resume();var w=a.lineNumber-1;(k=k.split("\n")[w])&&c.error("&#91;"+a.lineNumber+"&#93;: "+k)})}function u(a,j){try{if(typeof j=="function")j(function(){});else if(typeof j!="string")throw a+" must be string or function";}catch(k){h(k,a.toUpperCase());return false}return true}
function y(){var a=c.prop?c.prop("scrollHeight"):c.attr("scrollHeight");c.scrollTop(a)}function D(a){a=typeof a=="string"?a:String(a);var j,k,w;if(a.length>M){j=M;var p=[];k=/(\[\[[biu]*;[^;]*;\][^\]\[]*\]?)/g;w=/(\[\[[biu]*;[^;]*;\])/;a=a.split(/\n/g);for(var x="",r=0,F=a.length;r<F;++r){if(x!=="")if(a[r]===""){p.push(x+"]");continue}else{a[r]=x+a[r];x=""}for(var A=0,V=a[r].length;A<V;A+=j){var C=a[r].substring(A,A+j);if(x!=="")C=x+C;var Q=C.match(k),G=C.match(/\t/g);G=G?G.length:0;if(G>0){G*=3;
C=a[r].substring(A,A+j-G);A-=G;console.log(G)}if(Q&&Q.length>0){C=G=0;for(var la=Q.length;C<la;++C){G+=Q[C].match(w)[1].length;if(Q[C][Q[C].length-1]=="]")G+=1}if(x!=="")G-=x.length;C=x+a[r].substring(A,A+j+G);Q=C.match(k);x=Q[Q.length-1];A+=G;if(x[x.length-1]!="]"){C+="]";x=x.match(w)[1]}else x=""}else x="";p.push(C)}}j=g("<div></div>");k=0;for(w=p.length;k<w;++k)p[k]===""||p[k]=="\r"?j.append("<div>&nbsp;</div>"):g("<div/>").html(H(p[k])).appendTo(j)}else j=g("<div/>").html(H(a));f.append(j);j.width("100%");
y();return j}function T(a,j){var k=1,w=function(p,x){j.pause();g.jrpc(a,k++,p,x,function(r){if(r.error)j.error("&#91;RPC&#93; "+r.error.message);else if(typeof r.result=="string")j.echo(r.result);else if(r.result instanceof Array)j.echo(r.result.join(" "));else if(typeof r.result=="object"){var F="",A;for(A in r.result)if(r.result.hasOwnProperty(A))F+=A+": "+r.result[A]+"\n";j.echo(F)}j.resume()},function(r,F){j.error("&#91;AJAX&#93; "+F+" - Server reponse is: \n"+r.responseText);j.resume()})};return function(p,
x){if(p!==""){var r,F;if(p.match(/[^ ]* /)){p=p.split(/ +/);r=p[0];F=p.slice(1)}else{r=p;F=[]}if(!l.login||r=="help")w(r,F);else{var A=x.token();A?w(r,[A].concat(F)):x.error("&#91;AUTH&#93; Access denied (no token)")}}}}function m(a){var j=q.prompt();if(q.mask())a=a.replace(/./g,"*");typeof j=="function"?j(function(k){c.echo(k+" "+a)}):c.echo(j+" "+a)}function n(a){try{var j=z.top();if(a=="exit"&&l.exit)if(z.size()==1)l.login?L():c.echo("You can exit from main interpeter");else c.pop("exit");else{m(a);
if(a=="clear"&&l.clear)c.clear();else if(a.match(/\|/)){var k=a.split(/\s*\|\s*/),w=[],p=c.echo;c.echo=function(C){w.push(C)};j.eval(k[0],c);a=1;for(var x=k.length;a<x-1;++a)for(var r=0,F=w.length;r<F;++r){var A=k[a]+" "+w[r];j.eval(A,c)}c.echo=p;r=0;for(F=w.length;r<F;++r){A=k[x-1]+" "+w[r];j.eval(A,c)}}else j.eval(a,c)}}catch(V){h(V,"USER");c.resume();throw V;}}function K(){var a=null;q.prompt("login:");l.history&&q.history().disable();q.commands(function(j){try{m(j);if(a){q.mask(false);c.pause();
if(typeof l.login!="function")throw"Value of login property must be a function";l.login(a,j,function(w){if(w){var p=l.name;p=p?"_"+p:"";g.Storage.set("token"+p,w);g.Storage.set("login"+p,a);q.commands(n);I()}else{c.error("Wrong password try again");q.prompt("login:");a=null}c.resume();l.history&&q.history().enable()})}else{a=j;q.prompt("password:");q.mask(true)}}catch(k){h(k,"LOGIN",c);throw k;}})}function L(){var a=l.name;a=a?"_"+a:"";g.Storage.remove("token"+a,null);g.Storage.remove("login"+a,null);
l.history&&q.history().disable();K()}function U(){var a=z.top(),j="";if(a.name!==B&&a.name!=="")j+=a.name+"_";j+=s;q.name(j);q.prompt(a.prompt);l.history&&q.history().enable();q.set("");if(typeof a.onStart=="function")a.onStart(c)}function I(){U();if(d.greetings===B)c.echo(c.signature);else d.greetings&&c.echo(d.greetings);if(typeof l.onInit=="function")l.onInit(c)}function N(a){setTimeout(function(){if(t!=e()){c.resize();t=e()}},1);if(!c.paused()){if(l.keydown&&l.keydown(a,c)===false)return false;
if(a.which!=9)J=0;if(a.which==68&&a.ctrlKey){if(l.exit)if(q.get()==="")if(z.size()>1||l.login!==B)c.pop("");else{c.resume();c.echo("")}else c.set_command("");a.preventDefault()}else if(l.tabcompletion&&a.which==9){++J;a=q.get();if(!a.match(" ")){for(var j=RegExp("^"+a),k=z.top().command_list,w=[],p=k.length;p--;)j.test(k[p])&&w.push(k[p]);if(w.length==1)c.set_command(w[0]);else if(w.length>1)if(J>=2){m(a);c.echo(w.join("\t"));J=0}}return false}else if(a.which==86&&a.ctrlKey){c.oneTime(1,function(){y()});
return true}else if(a.which==9&&a.ctrlKey){P.length()>1&&c.focus(false);a.preventDefault()}else if(a.which==34)c.scroll(c.height());else a.which==33?c.scroll(-c.height()):c.attr({scrollTop:c.attr("scrollHeight")})}}var c=this,O=[],f,s=P.length(),M,R=[],l={name:"",prompt:">",history:true,exit:true,clear:true,enabled:true,login:null,tabcompletion:false,onInit:null,onExit:null,keypress:null,keydown:null};if(d){d.width&&c.width(d.width);d.height&&c.height(d.height);g.extend(l,d)}var E=!l.enabled;if(c.length===
0)throw'Sorry, but terminal said that "'+c.selector+'" is not valid selector!';c.ajaxSend(function(a,j){ka.push(j)});if(c.data("terminal"))return c.data("terminal");f=g("<div>").addClass("terminal-output").appendTo(c);c.addClass("terminal").append("<div/>");g.extend(c,{clear:function(){f.html("");q.set("");O=[];c.attr({scrollTop:0});return c},paused:function(){return E},pause:function(){if(q){c.disable();q.hide()}return c},resume:function(){if(q){c.enable();q.show();y()}return c},cols:function(){return M},
rows:function(){return O.length},history:function(){return q.history().data()},next:function(){if(P.length()==1)return c;else{var a=c.offset().top;c.height();c.scrollTop();var j=c,k=g(window).scrollTop(),w=k+g(window).height(),p=g(j).offset().top;if(p+g(j).height()>=k&&p<=w){P.front().disable();a=P.rotate().enable();j=a.offset().top-50;g("html,body").animate({scrollTop:j},500);return a}else{c.enable();g("html,body").animate({scrollTop:a-50},500);return c}}},focus:function(a){c.oneTime(1,function(){if(P.length()==
1)a===false?c.disable():c.enable();else if(a===false)c.next();else{P.front().disable();P.set(c);c.enable()}});return c},enable:function(){M===B&&c.resize();if(E)if(q){q.enable();E=false}return c},disable:function(){if(q){E=true;q.disable()}return c},enabled:function(){return E},signature:function(){var a=c.cols();a=a<15?null:a<35?0:a<55?1:a<64?2:a<75?3:4;return a!==null?ja[a].join("\n")+"\n":""},version:function(){return"0.4.5"},get_command:function(){return q.get()},insert:function(a){q.insert(a);
return c},set_prompt:function(a){u("prompt",a)&&q.prompt(a);return c},set_command:function(a){q.set(a);return c},set_mask:function(a){q.mask(a);return c},get_output:function(){return g.map(O,function(a,j){return typeof j=="function"?j():j}).get().join("\n")},resize:function(a,j){if(a&&j){c.width(a);c.height(j)}M=i();q.resize(M);var k=f.detach();f.html("");g.each(O,function(w,p){D(typeof p=="function"?p():p)});c.prepend(k);y();return c},echo:function(a){O.push(a);return D(typeof a=="function"?a():
a)},error:function(a){c.echo("[[;#f00;]"+a.replace(/\[/g,"&#91;").replace(/\]/g,"&#93;")+"]")},scroll:function(a){var j;if(c.prop){a>c.prop("scrollTop")&&a>0&&c.prop("scrollTop",0);j=c.prop("scrollTop");c.prop("scrollTop",j+a)}else{a>c.attr("scrollTop")&&a>0&&c.attr("scrollTop",0);j=c.attr("scrollTop");c.attr("scrollTop",j+a)}return c},logout:l.login?function(){for(;z.size()>1;)z.pop();L();return c}:function(){throw"You don't have login function";},token:l.login?function(){var a=l.name;return g.Storage.get("token"+
(a?"_"+a:""))}:null,login_name:l.login?function(){var a=l.name;return g.Storage.get("login"+(a?"_"+a:""))}:null,name:function(){return l.name},push:function(a,j){if(!j.prompt||u("prompt",j.prompt)){if(typeof a=="string")a=T(j.eval,c);z.push(g.extend({eval:a},j));U()}return c},pop:function(a){a!==B&&m(a);if(z.top().name===l.name){if(l.login){L();if(typeof l.onExit=="function")l.onExit(c)}}else{a=z.pop();U();if(typeof a.onExit=="function")a.onExit(c)}return c}});var J=0,t=e(),v;if(b.constructor==String){v=
b;b=T(b,c)}else if(b.constructor==Array)throw"You can't use array as eval";else if(typeof b=="object"){for(var o in b)R.push(o);b=function a(j){return function(k){if(k!==""){k=k.split(/ +/);var w=k[0],p=k.slice(1);k=j[w];var x=typeof k;if(x=="function")k.apply(c,p);else if(x=="object"||x=="string"){p=[];if(x=="object"){for(var r in k)p.push(r);k=a(k)}c.push(k,{prompt:w+">",name:w,command_list:p})}else c.error("Command '"+w+"' Not Found")}}}(b)}else if(typeof b!="function")throw'Unknow object "'+String(b)+
'" passed as eval';if(v&&(typeof l.login=="string"||l.login))l.login=function(a){var j=1;return function(k,w,p){c.pause();g.jrpc(v,j++,a,[k,w],function(x){c.resume();!x.error&&x.result?p(x.result):p(null)},function(x,r){c.resume();c.error("&#91;AJAX&#92; Response: "+r+"\n"+x.responseText)})}}(typeof l.login=="boolean"?"login":l.login);if(u("prompt",l.prompt)){var z=new ga({name:l.name,eval:b,prompt:l.prompt,command_list:R,greetings:l.greetings}),q=c.find(".terminal-output").next().cmd({prompt:l.prompt,
history:l.history,width:"100%",keydown:N,keypress:l.keypress?function(a){return l.keypress(a,c)}:null,commands:n});c.livequery(function(){c.resize()});P.append(c);l.enabled===true?c.focus():c.disable();g(window).resize(c.resize);c.click(function(){c.focus()});c.token&&!c.token()&&c.login_name&&!c.login_name()?K():I();typeof g.fn.init.prototype.mousewheel==="function"&&c.mousewheel(function(a,j){j>0?c.scroll(-40):c.scroll(40);return false},true)}c.data("terminal",c);return c}})(jQuery);
