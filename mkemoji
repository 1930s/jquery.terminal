#!/usr/bin/env node

const http = require('https');
const url = require('url');

function get({path, host}, callback) {
    http.get({
        path,
        host
    }, function(response) {
        if (response.headers.location) {
            var loc = response.headers.location;
            console.log(loc);
            if (loc.match(/^http/)) {
                loc = new url.Url(loc);
                host = loc.host;
                path = loc.path;
            } else {
                path = loc;
            }
            get({host, path}, callback);
        } else {
            callback(response);
        }
    });
}

get({
    host: 'unpkg.com',
    path: '/emoji-datasource-twitter/emoji.json'
}, function(response) {
    // Continuously update stream with data
    var body = '';
    response.on('data', function(data) {
        body += data;
    });
    response.on('end', function() {
        var emoji = JSON.parse(body);
        console.log(['/*',
                     ' * Autogenerated by mkemoji script from jQuery Terminal',
                     ' * Copyright (C) Jakub T. Jankiewicz <https://jcubic.pl>',
                     ' */'
                    ].join('\n'));
        emoji.map(function(emoji) {
            var url = 'https://unpkg.com/emoji-datasource-twitter/img/' +
                'twitter/64/' + emoji.image;
            // escape special characters in class name https://mathiasbynens.be/notes/css-escapes
            var class_name = emoji.short_name.replace(/\+/g, '\\+').replace(/^(\d)/i, '\\3$1 ');
            console.log(`.emoji.${class_name} { background-image: url(${url}); }`);
        });
    });
});
